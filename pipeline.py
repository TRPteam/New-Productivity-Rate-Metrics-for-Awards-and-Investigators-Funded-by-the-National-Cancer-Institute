

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.bec8d248-262b-4a56-8ae4-0fb2cc2eaa74"),
    GRANT_LIST=Input(rid="ri.foundry.main.dataset.832dbf46-9168-45dd-9764-c767b4c2912e"),
    RJD1=Input(rid="ri.foundry.main.dataset.d5e7e10f-76d5-4bee-b576-163ff0dd6d5d"),
    RJD2=Input(rid="ri.foundry.main.dataset.867b7cba-c251-48c3-b809-0d80ca706012"),
    RJD3=Input(rid="ri.foundry.main.dataset.9dad2ee6-f14a-4cb9-b048-dd9b47a81896"),
    RJD4=Input(rid="ri.foundry.main.dataset.9f035207-fdfd-46a0-adab-1eab66f57696")
)
from pyspark.sql import functions as F
def AWARD_COIN_CALC(GRANT_LIST, RJD1, RJD2, RJD3, RJD4):
    df=GRANT_LIST
    df=df.dropDuplicates(["G1","G2","Grant","Year"])
    df=df.join(RJD3,(df["Grant"]==RJD3["CORE_PROJECT_NUM"])&(df["Year"]==RJD3["FY"]),'inner')
    df=df.groupBy("CORE_PROJECT_NUM","FY","G1","G2").agg(F.collect_list("APPLICATION_TYPE").alias("APPL_TYPE_LIST"),F.collect_list("FULL_PROJECT_NUM").alias("FULL_PJ_NUM_LIST"),F.collect_list("APPLICATION_ID").alias("APPL_ID_LIST"),F.sum(df["TOTAL_COST"]).alias("SUM_TOTAL_COST"))
    df=df.withColumn("APPL_TYPE_LIST",F.concat_ws(";",F.col("APPL_TYPE_LIST")))
    df=df.withColumn("FULL_PJ_NUM_LIST",F.concat_ws(";",F.col("FULL_PJ_NUM_LIST")))
    df=df.withColumn("APPL_ID_LIST",F.concat_ws(";",F.col("APPL_ID_LIST")))
    df=df.filter(df["APPL_TYPE_LIST"]!="3")
    df=df.filter(df["SUM_TOTAL_COST"]>"10000")
    df=df.withColumn('FYplus1',df['FY']+1)
    df=df.join(RJD4,(df["CORE_PROJECT_NUM"]==RJD4["PROJECT_NUMBER"])&(df["FYplus1"]==RJD4["PubYr"]),'left')
    df=df.drop("PubYr")
    df=df.withColumnRenamed("PMID","PMID1")
    df=df.join(RJD1,(df["PMID1"]==RJD1["PMID"])&(df["FYplus1"]==RJD1["PubYr"]),'left')
    df=df.select("CORE_PROJECT_NUM","FY","G1","G2","APPL_TYPE_LIST","FULL_PJ_NUM_LIST","APPL_ID_LIST","SUM_TOTAL_COST","PMID","PubYr","RCR","Pub","PubPerHHSGr_FRAC","PubPerALLGr_FRAC","RCRperHHSGr_FRAC","RCRperALLGr_FRAC")
    df=df.withColumn("Pub",F.when(F.isnull("Pub"),0).otherwise(F.col("Pub")))
    df=df.withColumn("RCR",F.when(F.isnull("RCR"),0).otherwise(F.col("RCR")))
    df=df.withColumn("PubPerHHSGr_FRAC",F.when(F.isnull("PubPerHHSGr_FRAC"),0).otherwise(F.col("PubPerHHSGr_FRAC")))
    df=df.withColumn("PubPerALLGr_FRAC",F.when(F.isnull("PubPerALLGr_FRAC"),0).otherwise(F.col("PubPerALLGr_FRAC")))
    df=df.withColumn("RCRperHHSGr_FRAC",F.when(F.isnull("RCRperHHSGr_FRAC"),0).otherwise(F.col("RCRperHHSGr_FRAC")))
    df=df.withColumn("RCRperALLGr_FRAC",F.when(F.isnull("RCRperALLGr_FRAC"),0).otherwise(F.col("RCRperALLGr_FRAC")))
    df=df.join(RJD2,(df["PMID"]==RJD2["Cited_PMID"]),'left')
    df=df.withColumn("SUM_CitedPub",F.when(F.isnull("SUM_CitedPub"),0).otherwise(F.col("SUM_CitedPub")))
    df=df.withColumn("SUM_RCRofCitedPub",F.when(F.isnull("SUM_RCRofCitedPub"),0).otherwise(F.col("SUM_RCRofCitedPub")))
    df=df.withColumn("G_PubPerHHSGr_FRAC",F.when(F.isnull("G_PubPerHHSGr_FRAC"),0).otherwise(F.col("G_PubPerHHSGr_FRAC")))
    df=df.withColumn("G_PubPerALLGr_FRAC",F.when(F.isnull("G_PubPerALLGr_FRAC"),0).otherwise(F.col("G_PubPerALLGr_FRAC")))
    df=df.withColumn("G_RCRperHHSGr_FRAC",F.when(F.isnull("G_RCRperHHSGr_FRAC"),0).otherwise(F.col("G_RCRperHHSGr_FRAC")))
    df=df.withColumn("G_RCRperALLGr_FRAC",F.when(F.isnull("G_RCRperALLGr_FRAC"),0).otherwise(F.col("G_RCRperALLGr_FRAC")))
    df=df.withColumn("G_PMID_or_File_LIST",F.concat_ws(";",F.col("G_PMID_or_File_LIST")))
    df=df.withColumn("Guidelines_YR_LIST",F.concat_ws(";",F.col("Guidelines_YR_LIST")))
    df=df.withColumn("Guidelines_Topic_LIST",F.concat_ws(";",F.col("Guidelines_Topic_LIST")))
    df=df.groupBy("CORE_PROJECT_NUM","FY","G1","G2","APPL_TYPE_LIST","FULL_PJ_NUM_LIST","APPL_ID_LIST","SUM_TOTAL_COST","PubYr").agg(F.collect_list("PMID").alias("GrAllPubPMID_LIST"),F.sum(df["Pub"]).alias("SUM_GrAllPubCount"),F.sum("RCR").alias("SUM_GrAllPubRCR"),F.sum("PubPerHHSGr_FRAC").alias("SUM_PubPerHHSGr_FRAC"),F.sum("PubPerALLGr_FRAC").alias("SUM_PubPerALLGr_FRAC"),F.sum("RCRperHHSGr_FRAC").alias("SUM_RCRperHHSGr_FRAC"),F.sum("RCRperALLGr_FRAC").alias("SUM_RCRperALLGr_FRAC"),F.collect_list("Cited_PMID").alias("GrGAllPubPMID_LIST"),F.sum("SUM_CitedPub").alias("SSUM_GrGAllPubCount"),F.sum("SUM_RCRofCitedPub").alias("SSUM_GrGAllPubRCR"),F.sum("G_PubPerHHSGr_FRAC").alias("SUM_PubPerGHHSGr_FRAC"),F.sum("G_PubPerALLGr_FRAC").alias("SUM_PubPerGALLGr_FRAC"),F.sum("G_RCRperHHSGr_FRAC").alias("SUM_RCRperGHHSGr_FRAC"),F.sum("G_RCRperALLGr_FRAC").alias("SUM_RCRperGALLGr_FRAC"))
    df=df.groupBy("G1","G2","CORE_PROJECT_NUM").agg(F.sum("SUM_TOTAL_COST").alias("SUMS_TOTAL_COST"),F.sum("SUM_GrAllPubCount").alias("SUMS_GrAllPubCount"),F.sum("SUM_GrAllPubRCR").alias("SUMS_GrAllPubRCR"),F.sum("SUM_PubPerHHSGr_FRAC").alias("SUMS_PubPerHHSGr_FRAC"),F.sum("SUM_PubPerALLGr_FRAC").alias("SUMS_PubPerALLGr_FRAC"),F.sum("SUM_RCRperHHSGr_FRAC").alias("SUMS_RCRperHHSGr_FRAC"),F.sum("SUM_RCRperALLGr_FRAC").alias("SUMS_RCRperALLGr_FRAC"),F.sum("SSUM_GrGAllPubCount").alias("SSUMS_GrGAllPubCount"),F.sum("SSUM_GrGAllPubRCR").alias("SSUMS_GrGAllPubRCR"),F.sum("SUM_PubPerGHHSGr_FRAC").alias("SUMS_PubPerGHHSGr_FRAC"),F.sum("SUM_PubPerGALLGr_FRAC").alias("SUMS_PubPerGALLGr_FRAC"),F.sum("SUM_RCRperGHHSGr_FRAC").alias("SUMS_RCRperGHHSGr_FRAC"),F.sum("SUM_RCRperGALLGr_FRAC").alias("SUMS_RCRperGALLGr_FRAC"))
    df=df.withColumn("PubCostIDX_unFR",F.when(F.isnull("SUMS_GrAllPubCount"),0).otherwise(F.col("SUMS_GrAllPubCount")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("RCRcostIDX_unFR",F.when(F.isnull("SUMS_GrAllPubRCR"),0).otherwise(F.col("SUMS_GrAllPubRCR")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("PubCostIDX_HHS",F.when(F.isnull("SUMS_PubPerHHSGr_FRAC"),0).otherwise(F.col("SUMS_PubPerHHSGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("PubCostIDX_ALL",F.when(F.isnull("SUMS_PubPerALLGr_FRAC"),0).otherwise(F.col("SUMS_PubPerALLGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("RCRcostIDX_HHS",F.when(F.isnull("SUMS_RCRperHHSGr_FRAC"),0).otherwise(F.col("SUMS_RCRperHHSGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("RCRcostIDX_ALL",F.when(F.isnull("SUMS_RCRperALLGr_FRAC"),0).otherwise(F.col("SUMS_RCRperALLGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("Gu_PubCostIDX_unFR",F.when(F.isnull("SSUMS_GrGAllPubCount"),0).otherwise(F.col("SSUMS_GrGAllPubCount")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("Gu_RCRcostIDX_unFR",F.when(F.isnull("SSUMS_GrGAllPubRCR"),0).otherwise(F.col("SSUMS_GrGAllPubRCR")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("Gu_PubCostIDX_HHS",F.when(F.isnull("SUMS_PubPerGHHSGr_FRAC"),0).otherwise(F.col("SUMS_PubPerGHHSGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("Gu_PubCostIDX_ALL",F.when(F.isnull("SUMS_PubPerGALLGr_FRAC"),0).otherwise(F.col("SUMS_PubPerGALLGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("Gu_RCRcostIDX_HHS",F.when(F.isnull("SUMS_RCRperGHHSGr_FRAC"),0).otherwise(F.col("SUMS_RCRperGHHSGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.withColumn("Gu_RCRcostIDX_ALL",F.when(F.isnull("SUMS_RCRperGALLGr_FRAC"),0).otherwise(F.col("SUMS_RCRperGALLGr_FRAC")/F.col("SUMS_TOTAL_COST")*100000000))
    df=df.select("G1","G2","CORE_PROJECT_NUM","SUMS_TOTAL_COST","PubCostIDX_unFR","RCRcostIDX_unFR","PubCostIDX_ALL","RCRcostIDX_ALL","Gu_PubCostIDX_unFR","Gu_RCRcostIDX_unFR","Gu_PubCostIDX_ALL","Gu_RCRcostIDX_ALL")
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.855cd2d2-e005-4a8f-9516-182701eea2ae"),
    RJD5=Input(rid="ri.foundry.main.dataset.93eedd87-304f-4ece-b978-c90e51e133e4"),
    RJD6=Input(rid="ri.foundry.main.dataset.271816e3-02c8-4e60-9680-fb775ce164a9")
)
from pyspark.sql import functions as F
def CO_ACKNOWL(RJD5, RJD6):
    df=RJD5
    df=df.dropDuplicates(["G1","Proj_PI_Last_Name","Proj_PIID","Grant_Num","FY"])
    df=df.withColumn('PubYr',df['FY']+1)
    df=df.withColumn("Grant_Num",F.substring(df["Grant_Num"],-8,8))
    df=df.withColumn("Grant_Num_PubYr",F.concat(F.col("Grant_Num"),F.lit("-"),F.col("PubYr")))
    df=df.groupBy("G1","Proj_PIID","Proj_PI_Last_Name","PubYr").agg(F.collect_list("Grant_Num_PubYr").alias("Grant_Num_PubYr_LIST"),F.sum(df["Invr_TC_FR"]).alias("SUM_Invr_TC_FR"))
    df=df.filter(df["SUM_Invr_TC_FR"]>"10000")
    df=df.withColumn("Grant_Num_PubYr_LIST",F.concat_ws(",",F.col("Grant_Num_PubYr_LIST")))
    df=df.groupBy("G1","Proj_PIID","Proj_PI_Last_Name").agg(F.collect_list("Grant_Num_PubYr_LIST").alias("Grant_Num_PubYr_LIST2"),F.sum(df["SUM_Invr_TC_FR"]).alias("SSUM_Invr_TC_FR"))
    df=df.withColumn("Grant_Num_PubYr_LIST2",F.concat_ws(",",F.col("Grant_Num_PubYr_LIST2")))
    df=df.withColumn("Grant_Num_PubYr_LIST2",F.split(df["Grant_Num_PubYr_LIST2"],","))
    df=df.select("G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR",F.explode("Grant_Num_PubYr_LIST2").alias("Grant_Num_PubYr"))
    df=df.withColumn("Grant_Num",F.split(F.col("Grant_Num_PubYr"),"-").getItem(0)).withColumn("PubYr",F.split(F.col("Grant_Num_PubYr"),"-").getItem(1))
    df=df.join(RJD6,(df["Proj_PI_Last_Name"]==RJD6["AuLastName_Explode2"])&(df["PubYr"]==RJD6["Pub_Year"])&(df["Grant_Num"]==RJD6["Gr_Num_Explode"]),'left')
    df1=df.filter(df["G1"]=="P01")
    df1=df1.select("G1","Proj_PIID","Proj_PI_Last_Name","PubYr","PMID_Inv")
    df1=df1.distinct()
    df2=df.filter(df["G1"]=="P01_RPG&SPORE_MATCH")
    df2=df2.select("G1","Proj_PIID","Proj_PI_Last_Name","PubYr","PMID_Inv")
    df2=df2.withColumnRenamed("G1","G1_1").withColumnRenamed("Proj_PIID","Proj_PIID_1").withColumnRenamed("Proj_PI_Last_Name","Proj_PI_Last_Name_1").withColumnRenamed("PubYr","PubYr_1").withColumnRenamed("PMID_Inv","PMID_Inv_1")
    df2=df2.distinct()
    dfJ=df1.join(df2,(df1["Proj_PIID"]==df2["Proj_PIID_1"])&(df1["PMID_Inv"]==df2["PMID_Inv_1"]),'outer')
    df_FundYrsPub=dfJ.drop("PMID_Inv","PMID_Inv_1")
    df_FundYrsPub=df_FundYrsPub.distinct()
    df_FundYrsPub_SMPL=df_FundYrsPub.select("G1","Proj_PIID","Proj_PI_Last_Name","PubYr")
    df_FundYrsPub_SMPL=df_FundYrsPub_SMPL.dropna()
    df_FundYrsPub_SMPL=df_FundYrsPub_SMPL.distinct()
    df_FundYrsPub_COMP=df_FundYrsPub.select("G1_1","Proj_PIID_1","Proj_PI_Last_Name_1","PubYr_1")
    df_FundYrsPub_COMP=df_FundYrsPub_COMP.dropna()
    df_FundYrsPub_COMP=df_FundYrsPub_COMP.distinct()
    dfSC=df_FundYrsPub_SMPL.join(df_FundYrsPub_COMP,(df_FundYrsPub_SMPL["Proj_PIID"]==df_FundYrsPub_COMP["Proj_PIID_1"])&(df_FundYrsPub_SMPL["PubYr"]==df_FundYrsPub_COMP["PubYr_1"]),'inner')
    dfSC=dfSC.select("Proj_PIID","PubYr")
    dfSC=dfSC.withColumnRenamed("Proj_PIID","Proj_PIID_2").withColumnRenamed("PubYr","PubYr_2")
    df1SC=df1.join(dfSC,(df1["Proj_PIID"]==dfSC["Proj_PIID_2"])&(df1["PubYr"]==dfSC["PubYr_2"]),'inner')
    df2SC=df2.join(dfSC,(df2["Proj_PIID_1"]==dfSC["Proj_PIID_2"])&(df2["PubYr_1"]==dfSC["PubYr_2"]),'inner')
    df2SC=df2SC.withColumnRenamed("Proj_PIID_2","Proj_PIID_3").withColumnRenamed("PubYr_2","PubYr_3")
    df1SC=df1SC.withColumn("COUNTsamplePMID",F.lit(1))
    df2SC=df2SC.withColumn("COUNTcomparatorPMID",F.lit(1))
    df12SCi=df1SC.join(df2SC,(df1SC["Proj_PIID"]==df2SC["Proj_PIID_1"])&(df1SC["PMID_Inv"]==df2SC["PMID_Inv_1"]),'inner')
    df12SCi=df12SCi.groupBy("G1","G1_1","Proj_PIID","Proj_PI_Last_Name").agg(F.collect_list("PubYr").alias("PubYr_LIST"),F.collect_list("PMID_Inv").alias("PMID_Inv_LIST"),F.sum(df12SCi["COUNTsamplePMID"]).alias("COUNT_Pubs"))
    df12SCo=df1SC.join(df2SC,(df1SC["Proj_PIID"]==df2SC["Proj_PIID_1"])&(df1SC["PMID_Inv"]==df2SC["PMID_Inv_1"]),'outer')
    df12SCo=df12SCo.withColumn("Proj_PIID",F.when(F.isnull("Proj_PIID"),(df12SCo["Proj_PIID_1"])).otherwise(F.col("Proj_PIID")))
    df12SCo=df12SCo.withColumn("Proj_PI_Last_Name",F.when(F.isnull("Proj_PI_Last_Name"),(df12SCo["Proj_PI_Last_Name_1"])).otherwise(F.col("Proj_PI_Last_Name")))
    df12SCo=df12SCo.withColumn("PubYr",F.when(F.isnull("PubYr"),(df12SCo["PubYr_1"])).otherwise(F.col("PubYr")))
    df12SCo=df12SCo.withColumn("PMID_Inv",F.when(F.isnull("PMID_Inv"),(df12SCo["PMID_Inv_1"])).otherwise(F.col("PMID_Inv")))
    df12SCo=df12SCo.withColumn("COUNTsamplePMID",F.when(F.isnull("COUNTsamplePMID"),(df12SCo["COUNTcomparatorPMID"])).otherwise(F.col("COUNTsamplePMID")))
    df12SCo=df12SCo.select("Proj_PIID","Proj_PI_Last_Name","PubYr","PMID_Inv","COUNTsamplePMID")
    df12SCo=df12SCo.na.drop(subset=["PMID_Inv"])
    df12SCo=df12SCo.groupBy("Proj_PIID","Proj_PI_Last_Name").agg(F.collect_list("PubYr").alias("PubYr_LIST"),F.collect_list("PMID_Inv").alias("PMID_Inv_LIST"),F.sum(df12SCo["COUNTsamplePMID"]).alias("COUNT_Pubs"))
    df12SCi=df12SCi.withColumnRenamed("Proj_PIID","Proj_PIID-i").withColumnRenamed("Proj_PI_Last_Name","Proj_PI_Last_Name-i").withColumnRenamed("PubYr_LIST","PubYr_LIST-i").withColumnRenamed("PMID_Inv_LIST","PMID_Inv_LIST-i").withColumnRenamed("COUNT_Pubs","COUNT_Pubs-i")
    df12SCo=df12SCo.withColumnRenamed("Proj_PIID","Proj_PIID-o").withColumnRenamed("Proj_PI_Last_Name","Proj_PI_Last_Name-o").withColumnRenamed("PubYr_LIST","PubYr_LIST-o").withColumnRenamed("PMID_Inv_LIST","PMID_Inv_LIST-o").withColumnRenamed("COUNT_Pubs","COUNT_Pubs-o")
    dfPERCENT=df12SCi.join(df12SCo,(df12SCo["Proj_PIID-o"]==df12SCi["Proj_PIID-i"])&(df12SCo["Proj_PI_Last_Name-o"]==df12SCi["Proj_PI_Last_Name-i"]),'outer')
    dfPERCENT=dfPERCENT.withColumn("COUNT_Pubs-i",F.when(F.isnull("COUNT_Pubs-i"),0).otherwise(F.col("COUNT_Pubs-i")))
    dfPERCENT=dfPERCENT.withColumn("CO-ACKNOWLEDGED_PERCENT",F.col("COUNT_Pubs-i")/F.col("COUNT_Pubs-o")*100)
    return dfPERCENT

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.960592bc-f64b-46dc-a41d-3df9a984446a"),
    RJD1=Input(rid="ri.foundry.main.dataset.d5e7e10f-76d5-4bee-b576-163ff0dd6d5d"),
    RJD2=Input(rid="ri.foundry.main.dataset.867b7cba-c251-48c3-b809-0d80ca706012"),
    RJD5=Input(rid="ri.foundry.main.dataset.93eedd87-304f-4ece-b978-c90e51e133e4"),
    RJD6=Input(rid="ri.foundry.main.dataset.271816e3-02c8-4e60-9680-fb775ce164a9")
)
from pyspark.sql import functions as F
def INV_COIN_CALC(RJD5, RJD1, RJD2, RJD6):
    df=RJD5
    df=df.dropDuplicates(["G1","Proj_PI_Last_Name","Proj_PIID","Grant_Num","FY"])
    df=df.withColumn('PubYr',df['FY']+1)
    df=df.withColumn("Grant_Num",F.substring(df["Grant_Num"],-8,8))
    df=df.withColumn("Grant_Num_PubYr",F.concat(F.col("Grant_Num"),F.lit("-"),F.col("PubYr")))
    df=df.groupBy("G1","Proj_PIID","Proj_PI_Last_Name","PubYr").agg(F.collect_list("Grant_Num_PubYr").alias("Grant_Num_PubYr_LIST"),F.sum(df["Invr_TC_FR"]).alias("SUM_Invr_TC_FR"))
    df=df.filter(df["SUM_Invr_TC_FR"]>"10000")
    df=df.withColumn("Grant_Num_PubYr_LIST",F.concat_ws(",",F.col("Grant_Num_PubYr_LIST")))
    df=df.groupBy("G1","Proj_PIID","Proj_PI_Last_Name").agg(F.collect_list("Grant_Num_PubYr_LIST").alias("Grant_Num_PubYr_LIST2"),F.sum(df["SUM_Invr_TC_FR"]).alias("SSUM_Invr_TC_FR"))
    df=df.withColumn("Grant_Num_PubYr_LIST2",F.concat_ws(",",F.col("Grant_Num_PubYr_LIST2")))
    df=df.withColumn("Grant_Num_PubYr_LIST2",F.split(df["Grant_Num_PubYr_LIST2"],","))
    df=df.select("G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR",F.explode("Grant_Num_PubYr_LIST2").alias("Grant_Num_PubYr"))
    df=df.withColumn("Grant_Num",F.split(F.col("Grant_Num_PubYr"),"-").getItem(0)).withColumn("PubYr",F.split(F.col("Grant_Num_PubYr"),"-").getItem(1))
    df=df.join(RJD6,(df["Proj_PI_Last_Name"]==RJD6["AuLastName_Explode2"])&(df["PubYr"]==RJD6["Pub_Year"])&(df["Grant_Num"]==RJD6["Gr_Num_Explode"]),'left')
    df=df.select("G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR","Grant_Num","Pub_Year","PMID_Inv","Author_Count")
    df2=RJD1.select("PMID","Pub","RCR","PubPerHHSGr_FRAC","PubPerALLGr_FRAC","RCRperHHSGr_FRAC","RCRperALLGr_FRAC")
    df3=df.join(df2,(df["PMID_Inv"]==df2["PMID"]),'left')
    df3=df3.withColumn("Pub",F.when(F.isnull("Pub"),0).otherwise(F.col("Pub")))
    df3=df3.withColumn("RCR",F.when(F.isnull("RCR"),0).otherwise(F.col("RCR")))
    df3=df3.withColumn("PubPerHHSGr_FRAC",F.when(F.isnull("PubPerHHSGr_FRAC"),0).otherwise(F.col("PubPerHHSGr_FRAC")))
    df3=df3.withColumn("PubPerALLGr_FRAC",F.when(F.isnull("PubPerALLGr_FRAC"),0).otherwise(F.col("PubPerALLGr_FRAC")))
    df3=df3.withColumn("RCRperHHSGr_FRAC",F.when(F.isnull("RCRperHHSGr_FRAC"),0).otherwise(F.col("RCRperHHSGr_FRAC")))
    df3=df3.withColumn("RCRperALLGr_FRAC",F.when(F.isnull("RCRperALLGr_FRAC"),0).otherwise(F.col("RCRperALLGr_FRAC")))
    df3=df3.withColumn("Pub_F",F.when(F.isnull("Author_Count"),0).otherwise(F.col("Pub")/F.col("Author_Count")))
    df3=df3.withColumn("RCR_F",F.when(F.isnull("Author_Count"),0).otherwise(F.col("RCR")/F.col("Author_Count")))
    df3=df3.withColumn("PubPerHHSGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("PubPerHHSGr_FRAC")/F.col("Author_Count")))
    df3=df3.withColumn("PubPerALLGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("PubPerALLGr_FRAC")/F.col("Author_Count")))
    df3=df3.withColumn("RCRperHHSGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("RCRperHHSGr_FRAC")/F.col("Author_Count")))
    df3=df3.withColumn("RCRperALLGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("RCRperALLGr_FRAC")/F.col("Author_Count")))
    df3=df3.dropDuplicates(["G1","Proj_PIID","PMID"])
    df3=df3.groupBy("G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR").agg(F.sum(df3["Pub"]).alias("SUM_Pub"),F.sum(df3["RCR"]).alias("SUM_RCR"),F.sum(df3["PubPerHHSGr_FRAC"]).alias("SUM_PubPerHHSGr_FRAC"),F.sum(df3["PubPerALLGr_FRAC"]).alias("SUM_PubPerALLGr_FRAC"),F.sum(df3["RCRperHHSGr_FRAC"]).alias("SUM_RCRperHHSGr_FRAC"),F.sum(df3["RCRperALLGr_FRAC"]).alias("SUM_RCRperALLGr_FRAC"),F.sum(df3["Pub_F"]).alias("SUM_Pub_F"),F.sum(df3["RCR_F"]).alias("SUM_RCR_F"),F.sum(df3["PubPerHHSGr_FF"]).alias("SUM_PubPerHHSGr_FF"),F.sum(df3["PubPerALLGr_FF"]).alias("SUM_PubPerALLGr_FF"),F.sum(df3["RCRperHHSGr_FF"]).alias("SUM_RCRperHHSGr_FF"),F.sum(df3["RCRperALLGr_FF"]).alias("SUM_RCRperALLGr_FF"))
    df4=RJD2.select("Cited_PMID","SUM_CitedPub","SUM_RCRofCitedPub","G_PubPerHHSGr_FRAC","G_PubPerALLGr_FRAC","G_RCRperHHSGr_FRAC","G_RCRperALLGr_FRAC")
    df5=df.join(df4,(df["PMID_Inv"]==df4["Cited_PMID"]),'left')
    df5=df5.withColumn("SUM_CitedPub",F.when(F.isnull("SUM_CitedPub"),0).otherwise(F.col("SUM_CitedPub")))
    df5=df5.withColumn("SUM_RCRofCitedPub",F.when(F.isnull("SUM_RCRofCitedPub"),0).otherwise(F.col("SUM_RCRofCitedPub")))
    df5=df5.withColumn("G_PubPerHHSGr_FRAC",F.when(F.isnull("G_PubPerHHSGr_FRAC"),0).otherwise(F.col("G_PubPerHHSGr_FRAC")))
    df5=df5.withColumn("G_PubPerALLGr_FRAC",F.when(F.isnull("G_PubPerALLGr_FRAC"),0).otherwise(F.col("G_PubPerALLGr_FRAC")))
    df5=df5.withColumn("G_RCRperHHSGr_FRAC",F.when(F.isnull("G_RCRperHHSGr_FRAC"),0).otherwise(F.col("G_RCRperHHSGr_FRAC")))
    df5=df5.withColumn("G_RCRperALLGr_FRAC",F.when(F.isnull("G_RCRperALLGr_FRAC"),0).otherwise(F.col("G_RCRperALLGr_FRAC")))
    df5=df5.withColumn("SUM_CitedPub_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("SUM_CitedPub")/F.col("Author_Count")))
    df5=df5.withColumn("SUM_RCRofCitedPub_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("SUM_RCRofCitedPub")/F.col("Author_Count")))
    df5=df5.withColumn("G_PubPerHHSGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("G_PubPerHHSGr_FRAC")/F.col("Author_Count")))
    df5=df5.withColumn("G_PubPerALLGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("G_PubPerALLGr_FRAC")/F.col("Author_Count")))
    df5=df5.withColumn("G_RCRperHHSGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("G_RCRperHHSGr_FRAC")/F.col("Author_Count")))
    df5=df5.withColumn("G_RCRperALLGr_FF",F.when(F.isnull("Author_Count"),0).otherwise(F.col("G_RCRperALLGr_FRAC")/F.col("Author_Count")))
    df5=df5.dropDuplicates(["G1","Proj_PIID","Cited_PMID"])
    df5=df5.groupBy("G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR").agg(F.sum(df5["SUM_CitedPub"]).alias("SSUM_CitedPub"),F.sum(df5["SUM_RCRofCitedPub"]).alias("SSUM_RCRofCitedPub"),F.sum(df5["G_PubPerHHSGr_FRAC"]).alias("SUM_G_PubPerHHSGr_FRAC"),F.sum(df5["G_PubPerALLGr_FRAC"]).alias("SUM_G_PubPerALLGr_FRAC"),F.sum(df5["G_RCRperHHSGr_FRAC"]).alias("SUM_G_RCRperHHSGr_FRAC"),F.sum(df5["G_RCRperALLGr_FRAC"]).alias("SUM_G_RCRperALLGr_FRAC"),F.sum(df5["SUM_CitedPub_FF"]).alias("SSUM_CitedPub_FF"),F.sum(df5["SUM_RCRofCitedPub_FF"]).alias("SSUM_RCRofCitedPub_FF"),F.sum(df5["G_PubPerHHSGr_FF"]).alias("SUM_G_PubPerHHSGr_FF"),F.sum(df5["G_PubPerALLGr_FF"]).alias("SUM_G_PubPerALLGr_FF"),F.sum(df5["G_RCRperHHSGr_FF"]).alias("SUM_G_RCRperHHSGr_FF"),F.sum(df5["G_RCRperALLGr_FF"]).alias("SUM_G_RCRperALLGr_FF"))
    df=df.withColumnRenamed("G1","G1_")
    df=df.withColumnRenamed("Proj_PIID","ProjPIID")
    df=df.withColumnRenamed("Proj_PI_Last_Name","ProjPI_LastName")
    df=df.withColumnRenamed("SSUM_Invr_TC_FR","InvestigatorTC")
    df=df.groupBy("G1_","ProjPIID","ProjPI_LastName","InvestigatorTC").agg(F.collect_list("PMID_Inv").alias("PMID_LIST"))
    df10=df.join(df3,(df["G1_"]==df3["G1"])&(df["ProjPIID"]==df3["Proj_PIID"])&(df["ProjPI_LastName"]==df3["Proj_PI_Last_Name"]),'left')
    df10=df10.drop("PMID_LIST","G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR")
    df10=df10.join(df5,(df["G1_"]==df5["G1"])&(df["ProjPIID"]==df5["Proj_PIID"])&(df["ProjPI_LastName"]==df5["Proj_PI_Last_Name"]),'left')
    df10=df10.drop("G1","Proj_PIID","Proj_PI_Last_Name","SSUM_Invr_TC_FR")
    df10=df10.withColumn("Pub_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_Pub")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("RCR_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_RCR")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("PubPerHHSGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_PubPerHHSGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("PubPerALLGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_PubPerALLGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("RCRperHHSGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_RCRperHHSGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("RCRperALLGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_RCRperALLGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("PubAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_Pub_F")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("RCRAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_RCR_F")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("PubPerHHSGrFAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_PubPerHHSGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("PubPerALLGrFAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_PubPerALLGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("RCRperHHSGrFAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_RCRperHHSGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("RCRperALLGrFAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_RCRperALLGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuCitedPub_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SSUM_CitedPub")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuRCRofCitedPub_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SSUM_RCRofCitedPub")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuPubPerHHSGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_PubPerHHSGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuPubPerALLGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_PubPerALLGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuRCRperHHSGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_RCRperHHSGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuRCRperALLGrF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_RCRperALLGr_FRAC")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuPubFAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SSUM_CitedPub_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuRCRFAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SSUM_RCRofCitedPub_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuPubPerHHSGrAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_PubPerHHSGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuPubPerALLGrAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_PubPerALLGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuRCRperHHSGrAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_RCRperHHSGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.withColumn("GuRCRperALLGrAuF_CC",F.when(F.isnull("InvestigatorTC"),0).otherwise(F.col("SUM_G_RCRperALLGr_FF")/F.col("InvestigatorTC")*10000000))
    df10=df10.select("G1_","ProjPIID","ProjPI_LastName","InvestigatorTC","Pub_CC","RCR_CC","PubPerALLGrFAuF_CC","RCRperALLGrFAuF_CC","GuCitedPub_CC","GuRCRofCitedPub_CC","GuPubPerALLGrAuF_CC","GuRCRperALLGrAuF_CC")
    return df10

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.b2fc8862-2b37-44b6-8c10-f76f764709e9"),
    AWARD_COIN_CALC=Input(rid="ri.foundry.main.dataset.bec8d248-262b-4a56-8ae4-0fb2cc2eaa74")
)
from pyspark.sql import functions as F
def MEAN_SD_AWARD_COIN(AWARD_COIN_CALC):
    df=AWARD_COIN_CALC
    df=df.withColumn("GRANT_COUNT",F.lit(1))
    df=df.groupBy("G1","G2").agg(F.avg("PubCostIDX_unFR").alias("gRawPub_COINav"),F.stddev("PubCostIDX_unFR").alias("gRawPub_COINsd"),F.avg("RCRcostIDX_unFR").alias("gRawRCR_COINav"),F.stddev("RCRcostIDX_unFR").alias("gRawRCR_COINsd"),F.avg("PubCostIDX_ALL").alias("gALLfrPub_COINav"),F.stddev("PubCostIDX_ALL").alias("gALLfrPub_COINsd"),F.avg("RCRcostIDX_ALL").alias("gALLfrRCR_COINav"),F.stddev("RCRcostIDX_ALL").alias("gALLfrRCR_COINsd"),F.avg("Gu_PubCostIDX_unFR").alias("gGuRawPub_COINav"),F.stddev("Gu_PubCostIDX_unFR").alias("gGuRawPub_COINsd"),F.avg("Gu_RCRcostIDX_unFR").alias("gGuRawRCR_COINav"),F.stddev("Gu_RCRcostIDX_unFR").alias("gGuRawRCR_COINsd"),F.avg("Gu_PubCostIDX_ALL").alias("gGuALLfrPub_COINav"),F.stddev("Gu_PubCostIDX_ALL").alias("gGuALLfrPub_COINsd"),F.avg("Gu_RCRcostIDX_ALL").alias("gGuALLfrRCR_COINav"),F.stddev("Gu_RCRcostIDX_ALL").alias("gGuALLfrRCR_COINsd"),F.sum(df["GRANT_COUNT"]).alias("N_COUNT"),F.sum(df["SUMS_TOTAL_COST"]).alias("TC"))
    df=df.withColumn("rgRawPub_COINav",F.when(df["gRawPub_COINav"]>=1000,(F.round(df["gRawPub_COINav"],0))).otherwise(df["gRawPub_COINav"]))
    df=df.withColumn("rgRawPub_COINav",F.when((df["gRawPub_COINav"]<1000)&(df["gRawPub_COINav"]>=100),(F.round(df["gRawPub_COINav"],1))).otherwise(df["rgRawPub_COINav"]))
    df=df.withColumn("rgRawPub_COINav",F.when((df["gRawPub_COINav"]<100)&(df["gRawPub_COINav"]>=10),(F.round(df["gRawPub_COINav"],2))).otherwise(df["rgRawPub_COINav"]))
    df=df.withColumn("rgRawPub_COINav",F.when((df["gRawPub_COINav"]<10)&(df["gRawPub_COINav"]>=1),(F.round(df["gRawPub_COINav"],3))).otherwise(df["rgRawPub_COINav"]))
    df=df.withColumn("rgRawPub_COINav",F.when((df["gRawPub_COINav"]<1),(F.round(df["gRawPub_COINav"],4))).otherwise(df["rgRawPub_COINav"]))
    df=df.withColumn("rgRawPub_COINsd",F.when(df["gRawPub_COINsd"]>=1000,(F.round(df["gRawPub_COINsd"],0))).otherwise(df["gRawPub_COINsd"]))
    df=df.withColumn("rgRawPub_COINsd",F.when((df["gRawPub_COINsd"]<1000)&(df["gRawPub_COINsd"]>=100),(F.round(df["gRawPub_COINsd"],1))).otherwise(df["rgRawPub_COINsd"]))
    df=df.withColumn("rgRawPub_COINsd",F.when((df["gRawPub_COINsd"]<100)&(df["gRawPub_COINsd"]>=10),(F.round(df["gRawPub_COINsd"],2))).otherwise(df["rgRawPub_COINsd"]))
    df=df.withColumn("rgRawPub_COINsd",F.when((df["gRawPub_COINsd"]<10)&(df["gRawPub_COINsd"]>=1),(F.round(df["gRawPub_COINsd"],3))).otherwise(df["rgRawPub_COINsd"]))
    df=df.withColumn("rgRawPub_COINsd",F.when((df["gRawPub_COINsd"]<1),(F.round(df["gRawPub_COINsd"],4))).otherwise(df["rgRawPub_COINsd"]))
    df=df.withColumn("rgRawRCR_COINav",F.when(df["gRawRCR_COINav"]>=1000,(F.round(df["gRawRCR_COINav"],0))).otherwise(df["gRawRCR_COINav"]))
    df=df.withColumn("rgRawRCR_COINav",F.when((df["gRawRCR_COINav"]<1000)&(df["gRawRCR_COINav"]>=100),(F.round(df["gRawRCR_COINav"],1))).otherwise(df["rgRawRCR_COINav"]))
    df=df.withColumn("rgRawRCR_COINav",F.when((df["gRawRCR_COINav"]<100)&(df["gRawRCR_COINav"]>=10),(F.round(df["gRawRCR_COINav"],2))).otherwise(df["rgRawRCR_COINav"]))
    df=df.withColumn("rgRawRCR_COINav",F.when((df["gRawRCR_COINav"]<10)&(df["gRawRCR_COINav"]>=1),(F.round(df["gRawRCR_COINav"],3))).otherwise(df["rgRawRCR_COINav"]))
    df=df.withColumn("rgRawRCR_COINav",F.when((df["gRawRCR_COINav"]<1),(F.round(df["gRawRCR_COINav"],4))).otherwise(df["rgRawRCR_COINav"]))
    df=df.withColumn("rgRawRCR_COINsd",F.when(df["gRawRCR_COINsd"]>=1000,(F.round(df["gRawRCR_COINsd"],0))).otherwise(df["gRawRCR_COINsd"]))
    df=df.withColumn("rgRawRCR_COINsd",F.when((df["gRawRCR_COINsd"]<1000)&(df["gRawRCR_COINsd"]>=100),(F.round(df["gRawRCR_COINsd"],1))).otherwise(df["rgRawRCR_COINsd"]))
    df=df.withColumn("rgRawRCR_COINsd",F.when((df["gRawRCR_COINsd"]<100)&(df["gRawRCR_COINsd"]>=10),(F.round(df["gRawRCR_COINsd"],2))).otherwise(df["rgRawRCR_COINsd"]))
    df=df.withColumn("rgRawRCR_COINsd",F.when((df["gRawRCR_COINsd"]<10)&(df["gRawRCR_COINsd"]>=1),(F.round(df["gRawRCR_COINsd"],3))).otherwise(df["rgRawRCR_COINsd"]))
    df=df.withColumn("rgRawRCR_COINsd",F.when((df["gRawRCR_COINsd"]<1),(F.round(df["gRawRCR_COINsd"],4))).otherwise(df["rgRawRCR_COINsd"]))   
    df=df.withColumn("rgALLfrPub_COINav",F.when(df["gALLfrPub_COINav"]>=1000,(F.round(df["gALLfrPub_COINav"],0))).otherwise(df["gALLfrPub_COINav"]))
    df=df.withColumn("rgALLfrPub_COINav",F.when((df["gALLfrPub_COINav"]<1000)&(df["gALLfrPub_COINav"]>=100),(F.round(df["gALLfrPub_COINav"],1))).otherwise(df["rgALLfrPub_COINav"]))
    df=df.withColumn("rgALLfrPub_COINav",F.when((df["gALLfrPub_COINav"]<100)&(df["gALLfrPub_COINav"]>=10),(F.round(df["gALLfrPub_COINav"],2))).otherwise(df["rgALLfrPub_COINav"]))
    df=df.withColumn("rgALLfrPub_COINav",F.when((df["gALLfrPub_COINav"]<10)&(df["gALLfrPub_COINav"]>=1),(F.round(df["gALLfrPub_COINav"],3))).otherwise(df["rgALLfrPub_COINav"]))
    df=df.withColumn("rgALLfrPub_COINav",F.when((df["gALLfrPub_COINav"]<1),(F.round(df["gALLfrPub_COINav"],4))).otherwise(df["rgALLfrPub_COINav"]))
    df=df.withColumn("rgALLfrPub_COINsd",F.when(df["gALLfrPub_COINsd"]>=1000,(F.round(df["gALLfrPub_COINsd"],0))).otherwise(df["gALLfrPub_COINsd"]))
    df=df.withColumn("rgALLfrPub_COINsd",F.when((df["gALLfrPub_COINsd"]<1000)&(df["gALLfrPub_COINsd"]>=100),(F.round(df["gALLfrPub_COINsd"],1))).otherwise(df["rgALLfrPub_COINsd"]))
    df=df.withColumn("rgALLfrPub_COINsd",F.when((df["gALLfrPub_COINsd"]<100)&(df["gALLfrPub_COINsd"]>=10),(F.round(df["gALLfrPub_COINsd"],2))).otherwise(df["rgALLfrPub_COINsd"]))
    df=df.withColumn("rgALLfrPub_COINsd",F.when((df["gALLfrPub_COINsd"]<10)&(df["gALLfrPub_COINsd"]>=1),(F.round(df["gALLfrPub_COINsd"],3))).otherwise(df["rgALLfrPub_COINsd"]))
    df=df.withColumn("rgALLfrPub_COINsd",F.when((df["gALLfrPub_COINsd"]<1),(F.round(df["gALLfrPub_COINsd"],4))).otherwise(df["rgALLfrPub_COINsd"]))
    df=df.withColumn("rgALLfrRCR_COINav",F.when(df["gALLfrRCR_COINav"]>=1000,(F.round(df["gALLfrRCR_COINav"],0))).otherwise(df["gALLfrRCR_COINav"]))
    df=df.withColumn("rgALLfrRCR_COINav",F.when((df["gALLfrRCR_COINav"]<1000)&(df["gALLfrRCR_COINav"]>=100),(F.round(df["gALLfrRCR_COINav"],1))).otherwise(df["rgALLfrRCR_COINav"]))
    df=df.withColumn("rgALLfrRCR_COINav",F.when((df["gALLfrRCR_COINav"]<100)&(df["gALLfrRCR_COINav"]>=10),(F.round(df["gALLfrRCR_COINav"],2))).otherwise(df["rgALLfrRCR_COINav"]))
    df=df.withColumn("rgALLfrRCR_COINav",F.when((df["gALLfrRCR_COINav"]<10)&(df["gALLfrRCR_COINav"]>=1),(F.round(df["gALLfrRCR_COINav"],3))).otherwise(df["rgALLfrRCR_COINav"]))
    df=df.withColumn("rgALLfrRCR_COINav",F.when((df["gALLfrRCR_COINav"]<1),(F.round(df["gALLfrRCR_COINav"],4))).otherwise(df["rgALLfrRCR_COINav"]))
    df=df.withColumn("rgALLfrRCR_COINsd",F.when(df["gALLfrRCR_COINsd"]>=1000,(F.round(df["gALLfrRCR_COINsd"],0))).otherwise(df["gALLfrRCR_COINsd"]))
    df=df.withColumn("rgALLfrRCR_COINsd",F.when((df["gALLfrRCR_COINsd"]<1000)&(df["gALLfrRCR_COINsd"]>=100),(F.round(df["gALLfrRCR_COINsd"],1))).otherwise(df["rgALLfrRCR_COINsd"]))
    df=df.withColumn("rgALLfrRCR_COINsd",F.when((df["gALLfrRCR_COINsd"]<100)&(df["gALLfrRCR_COINsd"]>=10),(F.round(df["gALLfrRCR_COINsd"],2))).otherwise(df["rgALLfrRCR_COINsd"]))
    df=df.withColumn("rgALLfrRCR_COINsd",F.when((df["gALLfrRCR_COINsd"]<10)&(df["gALLfrRCR_COINsd"]>=1),(F.round(df["gALLfrRCR_COINsd"],3))).otherwise(df["rgALLfrRCR_COINsd"]))
    df=df.withColumn("rgALLfrRCR_COINsd",F.when((df["gALLfrRCR_COINsd"]<1),(F.round(df["gALLfrRCR_COINsd"],4))).otherwise(df["rgALLfrRCR_COINsd"]))
    df=df.withColumn("rgGuRawPub_COINav",F.when(df["gGuRawPub_COINav"]>=1000,(F.round(df["gGuRawPub_COINav"],0))).otherwise(df["gGuRawPub_COINav"]))
    df=df.withColumn("rgGuRawPub_COINav",F.when((df["gGuRawPub_COINav"]<1000)&(df["gGuRawPub_COINav"]>=100),(F.round(df["gGuRawPub_COINav"],1))).otherwise(df["rgGuRawPub_COINav"]))
    df=df.withColumn("rgGuRawPub_COINav",F.when((df["gGuRawPub_COINav"]<100)&(df["gGuRawPub_COINav"]>=10),(F.round(df["gGuRawPub_COINav"],2))).otherwise(df["rgGuRawPub_COINav"]))
    df=df.withColumn("rgGuRawPub_COINav",F.when((df["gGuRawPub_COINav"]<10)&(df["gGuRawPub_COINav"]>=1),(F.round(df["gGuRawPub_COINav"],3))).otherwise(df["rgGuRawPub_COINav"]))
    df=df.withColumn("rgGuRawPub_COINav",F.when((df["gGuRawPub_COINav"]<1),(F.round(df["gGuRawPub_COINav"],4))).otherwise(df["rgGuRawPub_COINav"]))
    df=df.withColumn("rgGuRawPub_COINsd",F.when(df["gGuRawPub_COINsd"]>=1000,(F.round(df["gGuRawPub_COINsd"],0))).otherwise(df["gGuRawPub_COINsd"]))
    df=df.withColumn("rgGuRawPub_COINsd",F.when((df["gGuRawPub_COINsd"]<1000)&(df["gGuRawPub_COINsd"]>=100),(F.round(df["gGuRawPub_COINsd"],1))).otherwise(df["rgGuRawPub_COINsd"]))
    df=df.withColumn("rgGuRawPub_COINsd",F.when((df["gGuRawPub_COINsd"]<100)&(df["gGuRawPub_COINsd"]>=10),(F.round(df["gGuRawPub_COINsd"],2))).otherwise(df["rgGuRawPub_COINsd"]))
    df=df.withColumn("rgGuRawPub_COINsd",F.when((df["gGuRawPub_COINsd"]<10)&(df["gGuRawPub_COINsd"]>=1),(F.round(df["gGuRawPub_COINsd"],3))).otherwise(df["rgGuRawPub_COINsd"]))
    df=df.withColumn("rgGuRawPub_COINsd",F.when((df["gGuRawPub_COINsd"]<1),(F.round(df["gGuRawPub_COINsd"],4))).otherwise(df["rgGuRawPub_COINsd"]))
    df=df.withColumn("rgGuRawRCR_COINav",F.when(df["gGuRawRCR_COINav"]>=1000,(F.round(df["gGuRawRCR_COINav"],0))).otherwise(df["gGuRawRCR_COINav"]))
    df=df.withColumn("rgGuRawRCR_COINav",F.when((df["gGuRawRCR_COINav"]<1000)&(df["gGuRawRCR_COINav"]>=100),(F.round(df["gGuRawRCR_COINav"],1))).otherwise(df["rgGuRawRCR_COINav"]))
    df=df.withColumn("rgGuRawRCR_COINav",F.when((df["gGuRawRCR_COINav"]<100)&(df["gGuRawRCR_COINav"]>=10),(F.round(df["gGuRawRCR_COINav"],2))).otherwise(df["rgGuRawRCR_COINav"]))
    df=df.withColumn("rgGuRawRCR_COINav",F.when((df["gGuRawRCR_COINav"]<10)&(df["gGuRawRCR_COINav"]>=1),(F.round(df["gGuRawRCR_COINav"],3))).otherwise(df["rgGuRawRCR_COINav"]))
    df=df.withColumn("rgGuRawRCR_COINav",F.when((df["gGuRawRCR_COINav"]<1),(F.round(df["gGuRawRCR_COINav"],4))).otherwise(df["rgGuRawRCR_COINav"]))
    df=df.withColumn("rgGuRawRCR_COINsd",F.when(df["gGuRawRCR_COINsd"]>=1000,(F.round(df["gGuRawRCR_COINsd"],0))).otherwise(df["gGuRawRCR_COINsd"]))
    df=df.withColumn("rgGuRawRCR_COINsd",F.when((df["gGuRawRCR_COINsd"]<1000)&(df["gGuRawRCR_COINsd"]>=100),(F.round(df["gGuRawRCR_COINsd"],1))).otherwise(df["rgGuRawRCR_COINsd"]))
    df=df.withColumn("rgGuRawRCR_COINsd",F.when((df["gGuRawRCR_COINsd"]<100)&(df["gGuRawRCR_COINsd"]>=10),(F.round(df["gGuRawRCR_COINsd"],2))).otherwise(df["rgGuRawRCR_COINsd"]))
    df=df.withColumn("rgGuRawRCR_COINsd",F.when((df["gGuRawRCR_COINsd"]<10)&(df["gGuRawRCR_COINsd"]>=1),(F.round(df["gGuRawRCR_COINsd"],3))).otherwise(df["rgGuRawRCR_COINsd"]))
    df=df.withColumn("rgGuRawRCR_COINsd",F.when((df["gGuRawRCR_COINsd"]<1),(F.round(df["gGuRawRCR_COINsd"],4))).otherwise(df["rgGuRawRCR_COINsd"]))
    df=df.withColumn("rgGuALLfrPub_COINav",F.when(df["gGuALLfrPub_COINav"]>=1000,(F.round(df["gGuALLfrPub_COINav"],0))).otherwise(df["gGuALLfrPub_COINav"]))
    df=df.withColumn("rgGuALLfrPub_COINav",F.when((df["gGuALLfrPub_COINav"]<1000)&(df["gGuALLfrPub_COINav"]>=100),(F.round(df["gGuALLfrPub_COINav"],1))).otherwise(df["rgGuALLfrPub_COINav"]))
    df=df.withColumn("rgGuALLfrPub_COINav",F.when((df["gGuALLfrPub_COINav"]<100)&(df["gGuALLfrPub_COINav"]>=10),(F.round(df["gGuALLfrPub_COINav"],2))).otherwise(df["rgGuALLfrPub_COINav"]))
    df=df.withColumn("rgGuALLfrPub_COINav",F.when((df["gGuALLfrPub_COINav"]<10)&(df["gGuALLfrPub_COINav"]>=1),(F.round(df["gGuALLfrPub_COINav"],3))).otherwise(df["rgGuALLfrPub_COINav"]))
    df=df.withColumn("rgGuALLfrPub_COINav",F.when((df["gGuALLfrPub_COINav"]<1),(F.round(df["gGuALLfrPub_COINav"],4))).otherwise(df["rgGuALLfrPub_COINav"]))
    df=df.withColumn("rgGuALLfrPub_COINsd",F.when(df["gGuALLfrPub_COINsd"]>=1000,(F.round(df["gGuALLfrPub_COINsd"],0))).otherwise(df["gGuALLfrPub_COINsd"]))
    df=df.withColumn("rgGuALLfrPub_COINsd",F.when((df["gGuALLfrPub_COINsd"]<1000)&(df["gGuALLfrPub_COINsd"]>=100),(F.round(df["gGuALLfrPub_COINsd"],1))).otherwise(df["rgGuALLfrPub_COINsd"]))
    df=df.withColumn("rgGuALLfrPub_COINsd",F.when((df["gGuALLfrPub_COINsd"]<100)&(df["gGuALLfrPub_COINsd"]>=10),(F.round(df["gGuALLfrPub_COINsd"],2))).otherwise(df["rgGuALLfrPub_COINsd"]))
    df=df.withColumn("rgGuALLfrPub_COINsd",F.when((df["gGuALLfrPub_COINsd"]<10)&(df["gGuALLfrPub_COINsd"]>=1),(F.round(df["gGuALLfrPub_COINsd"],3))).otherwise(df["rgGuALLfrPub_COINsd"]))
    df=df.withColumn("rgGuALLfrPub_COINsd",F.when((df["gGuALLfrPub_COINsd"]<1),(F.round(df["gGuALLfrPub_COINsd"],4))).otherwise(df["rgGuALLfrPub_COINsd"]))
    df=df.withColumn("rgGuALLfrRCR_COINav",F.when(df["gGuALLfrRCR_COINav"]>=1000,(F.round(df["gGuALLfrRCR_COINav"],0))).otherwise(df["gGuALLfrRCR_COINav"]))
    df=df.withColumn("rgGuALLfrRCR_COINav",F.when((df["gGuALLfrRCR_COINav"]<1000)&(df["gGuALLfrRCR_COINav"]>=100),(F.round(df["gGuALLfrRCR_COINav"],1))).otherwise(df["rgGuALLfrRCR_COINav"]))
    df=df.withColumn("rgGuALLfrRCR_COINav",F.when((df["gGuALLfrRCR_COINav"]<100)&(df["gGuALLfrRCR_COINav"]>=10),(F.round(df["gGuALLfrRCR_COINav"],2))).otherwise(df["rgGuALLfrRCR_COINav"]))
    df=df.withColumn("rgGuALLfrRCR_COINav",F.when((df["gGuALLfrRCR_COINav"]<10)&(df["gGuALLfrRCR_COINav"]>=1),(F.round(df["gGuALLfrRCR_COINav"],3))).otherwise(df["rgGuALLfrRCR_COINav"]))
    df=df.withColumn("rgGuALLfrRCR_COINav",F.when((df["gGuALLfrRCR_COINav"]<1),(F.round(df["gGuALLfrRCR_COINav"],4))).otherwise(df["rgGuALLfrRCR_COINav"]))
    df=df.withColumn("rgGuALLfrRCR_COINsd",F.when(df["gGuALLfrRCR_COINsd"]>=1000,(F.round(df["gGuALLfrRCR_COINsd"],0))).otherwise(df["gGuALLfrRCR_COINsd"]))
    df=df.withColumn("rgGuALLfrRCR_COINsd",F.when((df["gGuALLfrRCR_COINsd"]<1000)&(df["gGuALLfrRCR_COINsd"]>=100),(F.round(df["gGuALLfrRCR_COINsd"],1))).otherwise(df["rgGuALLfrRCR_COINsd"]))
    df=df.withColumn("rgGuALLfrRCR_COINsd",F.when((df["gGuALLfrRCR_COINsd"]<100)&(df["gGuALLfrRCR_COINsd"]>=10),(F.round(df["gGuALLfrRCR_COINsd"],2))).otherwise(df["rgGuALLfrRCR_COINsd"]))
    df=df.withColumn("rgGuALLfrRCR_COINsd",F.when((df["gGuALLfrRCR_COINsd"]<10)&(df["gGuALLfrRCR_COINsd"]>=1),(F.round(df["gGuALLfrRCR_COINsd"],3))).otherwise(df["rgGuALLfrRCR_COINsd"]))
    df=df.withColumn("rgGuALLfrRCR_COINsd",F.when((df["gGuALLfrRCR_COINsd"]<1),(F.round(df["gGuALLfrRCR_COINsd"],4))).otherwise(df["rgGuALLfrRCR_COINsd"]))
    df=df.select("G1","G2","N_COUNT","TC","rgRawPub_COINav","rgRawPub_COINsd","rgRawRCR_COINav","rgRawRCR_COINsd","rgALLfrPub_COINav","rgALLfrPub_COINsd","rgALLfrRCR_COINav","rgALLfrRCR_COINsd","rgGuRawPub_COINav","rgGuRawPub_COINsd","rgGuRawRCR_COINav","rgGuRawRCR_COINsd","rgGuALLfrPub_COINav","rgGuALLfrPub_COINsd","rgGuALLfrRCR_COINav","rgGuALLfrRCR_COINsd")
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.b053e300-cf02-4f2c-92fb-99f8f4dc48a2"),
    INV_COIN_CALC=Input(rid="ri.foundry.main.dataset.960592bc-f64b-46dc-a41d-3df9a984446a")
)
from pyspark.sql import functions as F
def MEAN_SD_INV_COIN(INV_COIN_CALC):
    df=INV_COIN_CALC
    df=df.withColumn("Inv_COUNT",F.lit(1))
    df=df.groupBy("G1_").agg(F.avg("Pub_CC").alias("iRawPub_COINav"),F.stddev("Pub_CC").alias("iRawPub_COINsd"),F.avg("RCR_CC").alias("iRawRCR_COINav"),F.stddev("RCR_CC").alias("iRawRCR_COINsd"),F.avg("PubPerALLGrFAuF_CC").alias("iAuALLfrPub_COINav"),F.stddev("PubPerALLGrFAuF_CC").alias("iAuALLfrPub_COINsd"),F.avg("RCRperALLGrFAuF_CC").alias("iAuALLfrRCR_COINav"),F.stddev("RCRperALLGrFAuF_CC").alias("iAuALLfrRCR_COINsd"),F.avg("GuCitedPub_CC").alias("iGuRawPub_COINav"),F.stddev("GuCitedPub_CC").alias("iGuRawPub_COINsd"),F.avg("GuRCRofCitedPub_CC").alias("iGuRawRCR_COINav"),F.stddev("GuRCRofCitedPub_CC").alias("iGuRawRCR_COINsd"),F.avg("GuPubPerALLGrAuF_CC").alias("iGuAuALLfrPub_COINav"),F.stddev("GuPubPerALLGrAuF_CC").alias("iGuAuALLfrPub_COINsd"),F.avg("GuRCRperALLGrAuF_CC").alias("iGuAuALLfrRCR_COINav"),F.stddev("GuRCRperALLGrAuF_CC").alias("iGuAuALLfrRCR_COINsd"),F.sum(df["Inv_COUNT"]).alias("N_COUNT"),F.sum(df["InvestigatorTC"]).alias("TC"))
    df=df.withColumn("riRawPub_COINav",F.when(df["iRawPub_COINav"]>=1000,(F.round(df["iRawPub_COINav"],0))).otherwise(df["iRawPub_COINav"]))
    df=df.withColumn("riRawPub_COINav",F.when((df["iRawPub_COINav"]<1000)&(df["iRawPub_COINav"]>=100),(F.round(df["iRawPub_COINav"],1))).otherwise(df["riRawPub_COINav"]))
    df=df.withColumn("riRawPub_COINav",F.when((df["iRawPub_COINav"]<100)&(df["iRawPub_COINav"]>=10),(F.round(df["iRawPub_COINav"],2))).otherwise(df["riRawPub_COINav"]))
    df=df.withColumn("riRawPub_COINav",F.when((df["iRawPub_COINav"]<10)&(df["iRawPub_COINav"]>=1),(F.round(df["iRawPub_COINav"],3))).otherwise(df["riRawPub_COINav"]))
    df=df.withColumn("riRawPub_COINav",F.when((df["iRawPub_COINav"]<1),(F.round(df["iRawPub_COINav"],4))).otherwise(df["riRawPub_COINav"]))
    df=df.withColumn("riRawPub_COINsd",F.when(df["iRawPub_COINsd"]>=1000,(F.round(df["iRawPub_COINsd"],0))).otherwise(df["iRawPub_COINsd"]))
    df=df.withColumn("riRawPub_COINsd",F.when((df["iRawPub_COINsd"]<1000)&(df["iRawPub_COINsd"]>=100),(F.round(df["iRawPub_COINsd"],1))).otherwise(df["riRawPub_COINsd"]))
    df=df.withColumn("riRawPub_COINsd",F.when((df["iRawPub_COINsd"]<100)&(df["iRawPub_COINsd"]>=10),(F.round(df["iRawPub_COINsd"],2))).otherwise(df["riRawPub_COINsd"]))
    df=df.withColumn("riRawPub_COINsd",F.when((df["iRawPub_COINsd"]<10)&(df["iRawPub_COINsd"]>=1),(F.round(df["iRawPub_COINsd"],3))).otherwise(df["riRawPub_COINsd"]))
    df=df.withColumn("riRawPub_COINsd",F.when((df["iRawPub_COINsd"]<1),(F.round(df["iRawPub_COINsd"],4))).otherwise(df["riRawPub_COINsd"]))
    df=df.withColumn("riRawRCR_COINav",F.when(df["iRawRCR_COINav"]>=1000,(F.round(df["iRawRCR_COINav"],0))).otherwise(df["iRawRCR_COINav"]))
    df=df.withColumn("riRawRCR_COINav",F.when((df["iRawRCR_COINav"]<1000)&(df["iRawRCR_COINav"]>=100),(F.round(df["iRawRCR_COINav"],1))).otherwise(df["riRawRCR_COINav"]))
    df=df.withColumn("riRawRCR_COINav",F.when((df["iRawRCR_COINav"]<100)&(df["iRawRCR_COINav"]>=10),(F.round(df["iRawRCR_COINav"],2))).otherwise(df["riRawRCR_COINav"]))
    df=df.withColumn("riRawRCR_COINav",F.when((df["iRawRCR_COINav"]<10)&(df["iRawRCR_COINav"]>=1),(F.round(df["iRawRCR_COINav"],3))).otherwise(df["riRawRCR_COINav"]))
    df=df.withColumn("riRawRCR_COINav",F.when((df["iRawRCR_COINav"]<1),(F.round(df["iRawRCR_COINav"],4))).otherwise(df["riRawRCR_COINav"]))
    df=df.withColumn("riRawRCR_COINsd",F.when(df["iRawRCR_COINsd"]>=1000,(F.round(df["iRawRCR_COINsd"],0))).otherwise(df["iRawRCR_COINsd"]))
    df=df.withColumn("riRawRCR_COINsd",F.when((df["iRawRCR_COINsd"]<1000)&(df["iRawRCR_COINsd"]>=100),(F.round(df["iRawRCR_COINsd"],1))).otherwise(df["riRawRCR_COINsd"]))
    df=df.withColumn("riRawRCR_COINsd",F.when((df["iRawRCR_COINsd"]<100)&(df["iRawRCR_COINsd"]>=10),(F.round(df["iRawRCR_COINsd"],2))).otherwise(df["riRawRCR_COINsd"]))
    df=df.withColumn("riRawRCR_COINsd",F.when((df["iRawRCR_COINsd"]<10)&(df["iRawRCR_COINsd"]>=1),(F.round(df["iRawRCR_COINsd"],3))).otherwise(df["riRawRCR_COINsd"]))
    df=df.withColumn("riRawRCR_COINsd",F.when((df["iRawRCR_COINsd"]<1),(F.round(df["iRawRCR_COINsd"],4))).otherwise(df["riRawRCR_COINsd"]))
    df=df.withColumn("riAuALLfrPub_COINav",F.when(df["iAuALLfrPub_COINav"]>=1000,(F.round(df["iAuALLfrPub_COINav"],0))).otherwise(df["iAuALLfrPub_COINav"]))
    df=df.withColumn("riAuALLfrPub_COINav",F.when((df["iAuALLfrPub_COINav"]<1000)&(df["iAuALLfrPub_COINav"]>=100),(F.round(df["iAuALLfrPub_COINav"],1))).otherwise(df["riAuALLfrPub_COINav"]))
    df=df.withColumn("riAuALLfrPub_COINav",F.when((df["iAuALLfrPub_COINav"]<100)&(df["iAuALLfrPub_COINav"]>=10),(F.round(df["iAuALLfrPub_COINav"],2))).otherwise(df["riAuALLfrPub_COINav"]))
    df=df.withColumn("riAuALLfrPub_COINav",F.when((df["iAuALLfrPub_COINav"]<10)&(df["iAuALLfrPub_COINav"]>=1),(F.round(df["iAuALLfrPub_COINav"],3))).otherwise(df["riAuALLfrPub_COINav"]))
    df=df.withColumn("riAuALLfrPub_COINav",F.when((df["iAuALLfrPub_COINav"]<1),(F.round(df["iAuALLfrPub_COINav"],4))).otherwise(df["riAuALLfrPub_COINav"]))
    df=df.withColumn("riAuALLfrPub_COINsd",F.when(df["iAuALLfrPub_COINsd"]>=1000,(F.round(df["iAuALLfrPub_COINsd"],0))).otherwise(df["iAuALLfrPub_COINsd"]))
    df=df.withColumn("riAuALLfrPub_COINsd",F.when((df["iAuALLfrPub_COINsd"]<1000)&(df["iAuALLfrPub_COINsd"]>=100),(F.round(df["iAuALLfrPub_COINsd"],1))).otherwise(df["riAuALLfrPub_COINsd"]))
    df=df.withColumn("riAuALLfrPub_COINsd",F.when((df["iAuALLfrPub_COINsd"]<100)&(df["iAuALLfrPub_COINsd"]>=10),(F.round(df["iAuALLfrPub_COINsd"],2))).otherwise(df["riAuALLfrPub_COINsd"]))
    df=df.withColumn("riAuALLfrPub_COINsd",F.when((df["iAuALLfrPub_COINsd"]<10)&(df["iAuALLfrPub_COINsd"]>=1),(F.round(df["iAuALLfrPub_COINsd"],3))).otherwise(df["riAuALLfrPub_COINsd"]))
    df=df.withColumn("riAuALLfrPub_COINsd",F.when((df["iAuALLfrPub_COINsd"]<1),(F.round(df["iAuALLfrPub_COINsd"],4))).otherwise(df["riAuALLfrPub_COINsd"]))  
    df=df.withColumn("riAuALLfrRCR_COINav",F.when(df["iAuALLfrRCR_COINav"]>=1000,(F.round(df["iAuALLfrRCR_COINav"],0))).otherwise(df["iAuALLfrRCR_COINav"]))
    df=df.withColumn("riAuALLfrRCR_COINav",F.when((df["iAuALLfrRCR_COINav"]<1000)&(df["iAuALLfrRCR_COINav"]>=100),(F.round(df["iAuALLfrRCR_COINav"],1))).otherwise(df["riAuALLfrRCR_COINav"]))
    df=df.withColumn("riAuALLfrRCR_COINav",F.when((df["iAuALLfrRCR_COINav"]<100)&(df["iAuALLfrRCR_COINav"]>=10),(F.round(df["iAuALLfrRCR_COINav"],2))).otherwise(df["riAuALLfrRCR_COINav"]))
    df=df.withColumn("riAuALLfrRCR_COINav",F.when((df["iAuALLfrRCR_COINav"]<10)&(df["iAuALLfrRCR_COINav"]>=1),(F.round(df["iAuALLfrRCR_COINav"],3))).otherwise(df["riAuALLfrRCR_COINav"]))
    df=df.withColumn("riAuALLfrRCR_COINav",F.when((df["iAuALLfrRCR_COINav"]<1),(F.round(df["iAuALLfrRCR_COINav"],4))).otherwise(df["riAuALLfrRCR_COINav"]))
    df=df.withColumn("riAuALLfrRCR_COINsd",F.when(df["iAuALLfrRCR_COINsd"]>=1000,(F.round(df["iAuALLfrRCR_COINsd"],0))).otherwise(df["iAuALLfrRCR_COINsd"]))
    df=df.withColumn("riAuALLfrRCR_COINsd",F.when((df["iAuALLfrRCR_COINsd"]<1000)&(df["iAuALLfrRCR_COINsd"]>=100),(F.round(df["iAuALLfrRCR_COINsd"],1))).otherwise(df["riAuALLfrRCR_COINsd"]))
    df=df.withColumn("riAuALLfrRCR_COINsd",F.when((df["iAuALLfrRCR_COINsd"]<100)&(df["iAuALLfrRCR_COINsd"]>=10),(F.round(df["iAuALLfrRCR_COINsd"],2))).otherwise(df["riAuALLfrRCR_COINsd"]))
    df=df.withColumn("riAuALLfrRCR_COINsd",F.when((df["iAuALLfrRCR_COINsd"]<10)&(df["iAuALLfrRCR_COINsd"]>=1),(F.round(df["iAuALLfrRCR_COINsd"],3))).otherwise(df["riAuALLfrRCR_COINsd"]))
    df=df.withColumn("riAuALLfrRCR_COINsd",F.when((df["iAuALLfrRCR_COINsd"]<1),(F.round(df["iAuALLfrRCR_COINsd"],4))).otherwise(df["riAuALLfrRCR_COINsd"]))
    df=df.withColumn("riGuRawPub_COINav",F.when(df["iGuRawPub_COINav"]>=1000,(F.round(df["iGuRawPub_COINav"],0))).otherwise(df["iGuRawPub_COINav"]))
    df=df.withColumn("riGuRawPub_COINav",F.when((df["iGuRawPub_COINav"]<1000)&(df["iGuRawPub_COINav"]>=100),(F.round(df["iGuRawPub_COINav"],1))).otherwise(df["riGuRawPub_COINav"]))
    df=df.withColumn("riGuRawPub_COINav",F.when((df["iGuRawPub_COINav"]<100)&(df["iGuRawPub_COINav"]>=10),(F.round(df["iGuRawPub_COINav"],2))).otherwise(df["riGuRawPub_COINav"]))
    df=df.withColumn("riGuRawPub_COINav",F.when((df["iGuRawPub_COINav"]<10)&(df["iGuRawPub_COINav"]>=1),(F.round(df["iGuRawPub_COINav"],3))).otherwise(df["riGuRawPub_COINav"]))
    df=df.withColumn("riGuRawPub_COINav",F.when((df["iGuRawPub_COINav"]<1),(F.round(df["iGuRawPub_COINav"],4))).otherwise(df["riGuRawPub_COINav"]))
    df=df.withColumn("riGuRawPub_COINsd",F.when(df["iGuRawPub_COINsd"]>=1000,(F.round(df["iGuRawPub_COINsd"],0))).otherwise(df["iGuRawPub_COINsd"]))
    df=df.withColumn("riGuRawPub_COINsd",F.when((df["iGuRawPub_COINsd"]<1000)&(df["iGuRawPub_COINsd"]>=100),(F.round(df["iGuRawPub_COINsd"],1))).otherwise(df["riGuRawPub_COINsd"]))
    df=df.withColumn("riGuRawPub_COINsd",F.when((df["iGuRawPub_COINsd"]<100)&(df["iGuRawPub_COINsd"]>=10),(F.round(df["iGuRawPub_COINsd"],2))).otherwise(df["riGuRawPub_COINsd"]))
    df=df.withColumn("riGuRawPub_COINsd",F.when((df["iGuRawPub_COINsd"]<10)&(df["iGuRawPub_COINsd"]>=1),(F.round(df["iGuRawPub_COINsd"],3))).otherwise(df["riGuRawPub_COINsd"]))
    df=df.withColumn("riGuRawPub_COINsd",F.when((df["iGuRawPub_COINsd"]<1),(F.round(df["iGuRawPub_COINsd"],4))).otherwise(df["riGuRawPub_COINsd"]))
    df=df.withColumn("riGuRawRCR_COINav",F.when(df["iGuRawRCR_COINav"]>=1000,(F.round(df["iGuRawRCR_COINav"],0))).otherwise(df["iGuRawRCR_COINav"]))
    df=df.withColumn("riGuRawRCR_COINav",F.when((df["iGuRawRCR_COINav"]<1000)&(df["iGuRawRCR_COINav"]>=100),(F.round(df["iGuRawRCR_COINav"],1))).otherwise(df["riGuRawRCR_COINav"]))
    df=df.withColumn("riGuRawRCR_COINav",F.when((df["iGuRawRCR_COINav"]<100)&(df["iGuRawRCR_COINav"]>=10),(F.round(df["iGuRawRCR_COINav"],2))).otherwise(df["riGuRawRCR_COINav"]))
    df=df.withColumn("riGuRawRCR_COINav",F.when((df["iGuRawRCR_COINav"]<10)&(df["iGuRawRCR_COINav"]>=1),(F.round(df["iGuRawRCR_COINav"],3))).otherwise(df["riGuRawRCR_COINav"]))
    df=df.withColumn("riGuRawRCR_COINav",F.when((df["iGuRawRCR_COINav"]<1),(F.round(df["iGuRawRCR_COINav"],4))).otherwise(df["riGuRawRCR_COINav"]))
    df=df.withColumn("riGuRawRCR_COINsd",F.when(df["iGuRawRCR_COINsd"]>=1000,(F.round(df["iGuRawRCR_COINsd"],0))).otherwise(df["iGuRawRCR_COINsd"]))
    df=df.withColumn("riGuRawRCR_COINsd",F.when((df["iGuRawRCR_COINsd"]<1000)&(df["iGuRawRCR_COINsd"]>=100),(F.round(df["iGuRawRCR_COINsd"],1))).otherwise(df["riGuRawRCR_COINsd"]))
    df=df.withColumn("riGuRawRCR_COINsd",F.when((df["iGuRawRCR_COINsd"]<100)&(df["iGuRawRCR_COINsd"]>=10),(F.round(df["iGuRawRCR_COINsd"],2))).otherwise(df["riGuRawRCR_COINsd"]))
    df=df.withColumn("riGuRawRCR_COINsd",F.when((df["iGuRawRCR_COINsd"]<10)&(df["iGuRawRCR_COINsd"]>=1),(F.round(df["iGuRawRCR_COINsd"],3))).otherwise(df["riGuRawRCR_COINsd"]))
    df=df.withColumn("riGuRawRCR_COINsd",F.when((df["iGuRawRCR_COINsd"]<1),(F.round(df["iGuRawRCR_COINsd"],4))).otherwise(df["riGuRawRCR_COINsd"]))  
    df=df.withColumn("riGuAuALLfrPub_COINav",F.when(df["iGuAuALLfrPub_COINav"]>=1000,(F.round(df["iGuAuALLfrPub_COINav"],0))).otherwise(df["iGuAuALLfrPub_COINav"]))
    df=df.withColumn("riGuAuALLfrPub_COINav",F.when((df["iGuAuALLfrPub_COINav"]<1000)&(df["iGuAuALLfrPub_COINav"]>=100),(F.round(df["iGuAuALLfrPub_COINav"],1))).otherwise(df["riGuAuALLfrPub_COINav"]))
    df=df.withColumn("riGuAuALLfrPub_COINav",F.when((df["iGuAuALLfrPub_COINav"]<100)&(df["iGuAuALLfrPub_COINav"]>=10),(F.round(df["iGuAuALLfrPub_COINav"],2))).otherwise(df["riGuAuALLfrPub_COINav"]))
    df=df.withColumn("riGuAuALLfrPub_COINav",F.when((df["iGuAuALLfrPub_COINav"]<10)&(df["iGuAuALLfrPub_COINav"]>=1),(F.round(df["iGuAuALLfrPub_COINav"],3))).otherwise(df["riGuAuALLfrPub_COINav"]))
    df=df.withColumn("riGuAuALLfrPub_COINav",F.when((df["iGuAuALLfrPub_COINav"]<1),(F.round(df["iGuAuALLfrPub_COINav"],4))).otherwise(df["riGuAuALLfrPub_COINav"]))
    df=df.withColumn("riGuAuALLfrPub_COINsd",F.when(df["iGuAuALLfrPub_COINsd"]>=1000,(F.round(df["iGuAuALLfrPub_COINsd"],0))).otherwise(df["iGuAuALLfrPub_COINsd"]))
    df=df.withColumn("riGuAuALLfrPub_COINsd",F.when((df["iGuAuALLfrPub_COINsd"]<1000)&(df["iGuAuALLfrPub_COINsd"]>=100),(F.round(df["iGuAuALLfrPub_COINsd"],1))).otherwise(df["riGuAuALLfrPub_COINsd"]))
    df=df.withColumn("riGuAuALLfrPub_COINsd",F.when((df["iGuAuALLfrPub_COINsd"]<100)&(df["iGuAuALLfrPub_COINsd"]>=10),(F.round(df["iGuAuALLfrPub_COINsd"],2))).otherwise(df["riGuAuALLfrPub_COINsd"]))
    df=df.withColumn("riGuAuALLfrPub_COINsd",F.when((df["iGuAuALLfrPub_COINsd"]<10)&(df["iGuAuALLfrPub_COINsd"]>=1),(F.round(df["iGuAuALLfrPub_COINsd"],3))).otherwise(df["riGuAuALLfrPub_COINsd"]))
    df=df.withColumn("riGuAuALLfrPub_COINsd",F.when((df["iGuAuALLfrPub_COINsd"]<1),(F.round(df["iGuAuALLfrPub_COINsd"],4))).otherwise(df["riGuAuALLfrPub_COINsd"]))
    df=df.withColumn("riGuAuALLfrRCR_COINav",F.when(df["iGuAuALLfrRCR_COINav"]>=1000,(F.round(df["iGuAuALLfrRCR_COINav"],0))).otherwise(df["iGuAuALLfrRCR_COINav"]))
    df=df.withColumn("riGuAuALLfrRCR_COINav",F.when((df["iGuAuALLfrRCR_COINav"]<1000)&(df["iGuAuALLfrRCR_COINav"]>=100),(F.round(df["iGuAuALLfrRCR_COINav"],1))).otherwise(df["riGuAuALLfrRCR_COINav"]))
    df=df.withColumn("riGuAuALLfrRCR_COINav",F.when((df["iGuAuALLfrRCR_COINav"]<100)&(df["iGuAuALLfrRCR_COINav"]>=10),(F.round(df["iGuAuALLfrRCR_COINav"],2))).otherwise(df["riGuAuALLfrRCR_COINav"]))
    df=df.withColumn("riGuAuALLfrRCR_COINav",F.when((df["iGuAuALLfrRCR_COINav"]<10)&(df["iGuAuALLfrRCR_COINav"]>=1),(F.round(df["iGuAuALLfrRCR_COINav"],3))).otherwise(df["riGuAuALLfrRCR_COINav"]))
    df=df.withColumn("riGuAuALLfrRCR_COINav",F.when((df["iGuAuALLfrRCR_COINav"]<1),(F.round(df["iGuAuALLfrRCR_COINav"],4))).otherwise(df["riGuAuALLfrRCR_COINav"]))
    df=df.withColumn("riGuAuALLfrRCR_COINsd",F.when(df["iGuAuALLfrRCR_COINsd"]>=1000,(F.round(df["iGuAuALLfrRCR_COINsd"],0))).otherwise(df["iGuAuALLfrRCR_COINsd"]))
    df=df.withColumn("riGuAuALLfrRCR_COINsd",F.when((df["iGuAuALLfrRCR_COINsd"]<1000)&(df["iGuAuALLfrRCR_COINsd"]>=100),(F.round(df["iGuAuALLfrRCR_COINsd"],1))).otherwise(df["riGuAuALLfrRCR_COINsd"]))
    df=df.withColumn("riGuAuALLfrRCR_COINsd",F.when((df["iGuAuALLfrRCR_COINsd"]<100)&(df["iGuAuALLfrRCR_COINsd"]>=10),(F.round(df["iGuAuALLfrRCR_COINsd"],2))).otherwise(df["riGuAuALLfrRCR_COINsd"]))
    df=df.withColumn("riGuAuALLfrRCR_COINsd",F.when((df["iGuAuALLfrRCR_COINsd"]<10)&(df["iGuAuALLfrRCR_COINsd"]>=1),(F.round(df["iGuAuALLfrRCR_COINsd"],3))).otherwise(df["riGuAuALLfrRCR_COINsd"]))
    df=df.withColumn("riGuAuALLfrRCR_COINsd",F.when((df["iGuAuALLfrRCR_COINsd"]<1),(F.round(df["iGuAuALLfrRCR_COINsd"],4))).otherwise(df["riGuAuALLfrRCR_COINsd"]))
    df=df.select("G1_","N_COUNT","TC","riRawPub_COINav","riRawPub_COINsd","riRawRCR_COINav","riRawRCR_COINsd","riAuALLfrPub_COINav","riAuALLfrPub_COINsd","riAuALLfrRCR_COINav","riAuALLfrRCR_COINsd","riGuRawPub_COINav","riGuRawPub_COINsd","riGuRawRCR_COINav","riGuRawRCR_COINsd","riGuAuALLfrPub_COINav","riGuAuALLfrPub_COINsd","riGuAuALLfrRCR_COINav","riGuAuALLfrRCR_COINsd") 
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.98c583c0-d8b1-4cda-8ae9-e4ae1aac5bee"),
    AWARD_COIN_CALC=Input(rid="ri.foundry.main.dataset.bec8d248-262b-4a56-8ae4-0fb2cc2eaa74")
)
from pyspark.sql import functions as F
def MEDIAN_AWARD_COIN(AWARD_COIN_CALC):
    df=AWARD_COIN_CALC
    df=df.withColumn("GRANT_COUNT",F.lit(1))
    df=df.groupBy("G1","G2").agg(F.percentile_approx("PubCostIDX_unFR",0.5).alias("gRawPub_COIN50"),F.percentile_approx("PubCostIDX_unFR",0.75).alias("gRawPub_COIN75"),F.percentile_approx("PubCostIDX_unFR",0.25).alias("gRawPub_COIN25"),F.percentile_approx("RCRcostIDX_unFR",0.5).alias("gRawRCR_COIN50"),F.percentile_approx("RCRcostIDX_unFR",0.75).alias("gRawRCR_COIN75"),F.percentile_approx("RCRcostIDX_unFR",0.25).alias("gRawRCR_COIN25"),F.percentile_approx("PubCostIDX_ALL",0.5).alias("gALLfrPub_COIN50"),F.percentile_approx("PubCostIDX_ALL",0.75).alias("gALLfrPub_COIN75"),F.percentile_approx("PubCostIDX_ALL",0.25).alias("gALLfrPub_COIN25"),F.percentile_approx("RCRcostIDX_ALL",0.5).alias("gALLfrRCR_COIN50"),F.percentile_approx("RCRcostIDX_ALL",0.75).alias("gALLfrRCR_COIN75"),F.percentile_approx("RCRcostIDX_ALL",0.25).alias("gALLfrRCR_COIN25"),F.percentile_approx("Gu_PubCostIDX_unFR",0.5).alias("gGuRawPub_COIN50"),F.percentile_approx("Gu_PubCostIDX_unFR",0.75).alias("gGuRawPub_COIN75"),F.percentile_approx("Gu_PubCostIDX_unFR",0.25).alias("gGuRawPub_COIN25"),F.percentile_approx("Gu_RCRcostIDX_unFR",0.5).alias("gGuRawRCR_COIN50"),F.percentile_approx("Gu_RCRcostIDX_unFR",0.75).alias("gGuRawRCR_COIN75"),F.percentile_approx("Gu_RCRcostIDX_unFR",0.25).alias("gGuRawRCR_COIN25"),F.percentile_approx("Gu_PubCostIDX_ALL",0.5).alias("gGuALLfrPub_COIN50"),F.percentile_approx("Gu_PubCostIDX_ALL",0.75).alias("gGuALLfrPub_COIN75"),F.percentile_approx("Gu_PubCostIDX_ALL",0.25).alias("gGuALLfrPub_COIN25"),F.percentile_approx("Gu_RCRcostIDX_ALL",0.5).alias("gGuALLfrRCR_COIN50"),F.percentile_approx("Gu_RCRcostIDX_ALL",0.75).alias("gGuALLfrRCR_COIN75"),F.percentile_approx("Gu_RCRcostIDX_ALL",0.25).alias("gGuALLfrRCR_COIN25"),F.sum(df["GRANT_COUNT"]).alias("N_COUNT"),F.sum(df["SUMS_TOTAL_COST"]).alias("TC"))
    df=df.withColumn("rgRawPub_COIN50",F.when(df["gRawPub_COIN50"]>=1000,(F.round(df["gRawPub_COIN50"],0))).otherwise(df["gRawPub_COIN50"]))
    df=df.withColumn("rgRawPub_COIN50",F.when((df["gRawPub_COIN50"]<1000)&(df["gRawPub_COIN50"]>=100),(F.round(df["gRawPub_COIN50"],1))).otherwise(df["rgRawPub_COIN50"]))
    df=df.withColumn("rgRawPub_COIN50",F.when((df["gRawPub_COIN50"]<100)&(df["gRawPub_COIN50"]>=10),(F.round(df["gRawPub_COIN50"],2))).otherwise(df["rgRawPub_COIN50"]))
    df=df.withColumn("rgRawPub_COIN50",F.when((df["gRawPub_COIN50"]<10)&(df["gRawPub_COIN50"]>=1),(F.round(df["gRawPub_COIN50"],3))).otherwise(df["rgRawPub_COIN50"]))
    df=df.withColumn("rgRawPub_COIN50",F.when((df["gRawPub_COIN50"]<1),(F.round(df["gRawPub_COIN50"],4))).otherwise(df["rgRawPub_COIN50"]))
    df=df.withColumn("rgRawPub_COIN75",F.when(df["gRawPub_COIN75"]>=1000,(F.round(df["gRawPub_COIN75"],0))).otherwise(df["gRawPub_COIN75"]))
    df=df.withColumn("rgRawPub_COIN75",F.when((df["gRawPub_COIN75"]<1000)&(df["gRawPub_COIN75"]>=100),(F.round(df["gRawPub_COIN75"],1))).otherwise(df["rgRawPub_COIN75"]))
    df=df.withColumn("rgRawPub_COIN75",F.when((df["gRawPub_COIN75"]<100)&(df["gRawPub_COIN75"]>=10),(F.round(df["gRawPub_COIN75"],2))).otherwise(df["rgRawPub_COIN75"]))
    df=df.withColumn("rgRawPub_COIN75",F.when((df["gRawPub_COIN75"]<10)&(df["gRawPub_COIN75"]>=1),(F.round(df["gRawPub_COIN75"],3))).otherwise(df["rgRawPub_COIN75"]))
    df=df.withColumn("rgRawPub_COIN75",F.when((df["gRawPub_COIN75"]<1),(F.round(df["gRawPub_COIN75"],4))).otherwise(df["rgRawPub_COIN75"]))
    df=df.withColumn("rgRawPub_COIN25",F.when(df["gRawPub_COIN25"]>=1000,(F.round(df["gRawPub_COIN25"],0))).otherwise(df["gRawPub_COIN25"]))
    df=df.withColumn("rgRawPub_COIN25",F.when((df["gRawPub_COIN25"]<1000)&(df["gRawPub_COIN25"]>=100),(F.round(df["gRawPub_COIN25"],1))).otherwise(df["rgRawPub_COIN25"]))
    df=df.withColumn("rgRawPub_COIN25",F.when((df["gRawPub_COIN25"]<100)&(df["gRawPub_COIN25"]>=10),(F.round(df["gRawPub_COIN25"],2))).otherwise(df["rgRawPub_COIN25"]))
    df=df.withColumn("rgRawPub_COIN25",F.when((df["gRawPub_COIN25"]<10)&(df["gRawPub_COIN25"]>=1),(F.round(df["gRawPub_COIN25"],3))).otherwise(df["rgRawPub_COIN25"]))
    df=df.withColumn("rgRawPub_COIN25",F.when((df["gRawPub_COIN25"]<1),(F.round(df["gRawPub_COIN25"],4))).otherwise(df["rgRawPub_COIN25"]))
    df=df.withColumn("rgRawRCR_COIN50",F.when(df["gRawRCR_COIN50"]>=1000,(F.round(df["gRawRCR_COIN50"],0))).otherwise(df["gRawRCR_COIN50"]))
    df=df.withColumn("rgRawRCR_COIN50",F.when((df["gRawRCR_COIN50"]<1000)&(df["gRawRCR_COIN50"]>=100),(F.round(df["gRawRCR_COIN50"],1))).otherwise(df["rgRawRCR_COIN50"]))
    df=df.withColumn("rgRawRCR_COIN50",F.when((df["gRawRCR_COIN50"]<100)&(df["gRawRCR_COIN50"]>=10),(F.round(df["gRawRCR_COIN50"],2))).otherwise(df["rgRawRCR_COIN50"]))
    df=df.withColumn("rgRawRCR_COIN50",F.when((df["gRawRCR_COIN50"]<10)&(df["gRawRCR_COIN50"]>=1),(F.round(df["gRawRCR_COIN50"],3))).otherwise(df["rgRawRCR_COIN50"]))
    df=df.withColumn("rgRawRCR_COIN50",F.when((df["gRawRCR_COIN50"]<1),(F.round(df["gRawRCR_COIN50"],4))).otherwise(df["rgRawRCR_COIN50"]))
    df=df.withColumn("rgRawRCR_COIN75",F.when(df["gRawRCR_COIN75"]>=1000,(F.round(df["gRawRCR_COIN75"],0))).otherwise(df["gRawRCR_COIN75"]))
    df=df.withColumn("rgRawRCR_COIN75",F.when((df["gRawRCR_COIN75"]<1000)&(df["gRawRCR_COIN75"]>=100),(F.round(df["gRawRCR_COIN75"],1))).otherwise(df["rgRawRCR_COIN75"]))
    df=df.withColumn("rgRawRCR_COIN75",F.when((df["gRawRCR_COIN75"]<100)&(df["gRawRCR_COIN75"]>=10),(F.round(df["gRawRCR_COIN75"],2))).otherwise(df["rgRawRCR_COIN75"]))
    df=df.withColumn("rgRawRCR_COIN75",F.when((df["gRawRCR_COIN75"]<10)&(df["gRawRCR_COIN75"]>=1),(F.round(df["gRawRCR_COIN75"],3))).otherwise(df["rgRawRCR_COIN75"]))
    df=df.withColumn("rgRawRCR_COIN75",F.when((df["gRawRCR_COIN75"]<1),(F.round(df["gRawRCR_COIN75"],4))).otherwise(df["rgRawRCR_COIN75"]))
    df=df.withColumn("rgRawRCR_COIN25",F.when(df["gRawRCR_COIN25"]>=1000,(F.round(df["gRawRCR_COIN25"],0))).otherwise(df["gRawRCR_COIN25"]))
    df=df.withColumn("rgRawRCR_COIN25",F.when((df["gRawRCR_COIN25"]<1000)&(df["gRawRCR_COIN25"]>=100),(F.round(df["gRawRCR_COIN25"],1))).otherwise(df["rgRawRCR_COIN25"]))
    df=df.withColumn("rgRawRCR_COIN25",F.when((df["gRawRCR_COIN25"]<100)&(df["gRawRCR_COIN25"]>=10),(F.round(df["gRawRCR_COIN25"],2))).otherwise(df["rgRawRCR_COIN25"]))
    df=df.withColumn("rgRawRCR_COIN25",F.when((df["gRawRCR_COIN25"]<10)&(df["gRawRCR_COIN25"]>=1),(F.round(df["gRawRCR_COIN25"],3))).otherwise(df["rgRawRCR_COIN25"]))
    df=df.withColumn("rgRawRCR_COIN25",F.when((df["gRawRCR_COIN25"]<1),(F.round(df["gRawRCR_COIN25"],4))).otherwise(df["rgRawRCR_COIN25"]))
    df=df.withColumn("rgALLfrPub_COIN50",F.when(df["gALLfrPub_COIN50"]>=1000,(F.round(df["gALLfrPub_COIN50"],0))).otherwise(df["gALLfrPub_COIN50"]))
    df=df.withColumn("rgALLfrPub_COIN50",F.when((df["gALLfrPub_COIN50"]<1000)&(df["gALLfrPub_COIN50"]>=100),(F.round(df["gALLfrPub_COIN50"],1))).otherwise(df["rgALLfrPub_COIN50"]))
    df=df.withColumn("rgALLfrPub_COIN50",F.when((df["gALLfrPub_COIN50"]<100)&(df["gALLfrPub_COIN50"]>=10),(F.round(df["gALLfrPub_COIN50"],2))).otherwise(df["rgALLfrPub_COIN50"]))
    df=df.withColumn("rgALLfrPub_COIN50",F.when((df["gALLfrPub_COIN50"]<10)&(df["gALLfrPub_COIN50"]>=1),(F.round(df["gALLfrPub_COIN50"],3))).otherwise(df["rgALLfrPub_COIN50"]))
    df=df.withColumn("rgALLfrPub_COIN50",F.when((df["gALLfrPub_COIN50"]<1),(F.round(df["gALLfrPub_COIN50"],4))).otherwise(df["rgALLfrPub_COIN50"]))
    df=df.withColumn("rgALLfrPub_COIN75",F.when(df["gALLfrPub_COIN75"]>=1000,(F.round(df["gALLfrPub_COIN75"],0))).otherwise(df["gALLfrPub_COIN75"]))
    df=df.withColumn("rgALLfrPub_COIN75",F.when((df["gALLfrPub_COIN75"]<1000)&(df["gALLfrPub_COIN75"]>=100),(F.round(df["gALLfrPub_COIN75"],1))).otherwise(df["rgALLfrPub_COIN75"]))
    df=df.withColumn("rgALLfrPub_COIN75",F.when((df["gALLfrPub_COIN75"]<100)&(df["gALLfrPub_COIN75"]>=10),(F.round(df["gALLfrPub_COIN75"],2))).otherwise(df["rgALLfrPub_COIN75"]))
    df=df.withColumn("rgALLfrPub_COIN75",F.when((df["gALLfrPub_COIN75"]<10)&(df["gALLfrPub_COIN75"]>=1),(F.round(df["gALLfrPub_COIN75"],3))).otherwise(df["rgALLfrPub_COIN75"]))
    df=df.withColumn("rgALLfrPub_COIN75",F.when((df["gALLfrPub_COIN75"]<1),(F.round(df["gALLfrPub_COIN75"],4))).otherwise(df["rgALLfrPub_COIN75"]))
    df=df.withColumn("rgALLfrPub_COIN25",F.when(df["gALLfrPub_COIN25"]>=1000,(F.round(df["gALLfrPub_COIN25"],0))).otherwise(df["gALLfrPub_COIN25"]))
    df=df.withColumn("rgALLfrPub_COIN25",F.when((df["gALLfrPub_COIN25"]<1000)&(df["gALLfrPub_COIN25"]>=100),(F.round(df["gALLfrPub_COIN25"],1))).otherwise(df["rgALLfrPub_COIN25"]))
    df=df.withColumn("rgALLfrPub_COIN25",F.when((df["gALLfrPub_COIN25"]<100)&(df["gALLfrPub_COIN25"]>=10),(F.round(df["gALLfrPub_COIN25"],2))).otherwise(df["rgALLfrPub_COIN25"]))
    df=df.withColumn("rgALLfrPub_COIN25",F.when((df["gALLfrPub_COIN25"]<10)&(df["gALLfrPub_COIN25"]>=1),(F.round(df["gALLfrPub_COIN25"],3))).otherwise(df["rgALLfrPub_COIN25"]))
    df=df.withColumn("rgALLfrPub_COIN25",F.when((df["gALLfrPub_COIN25"]<1),(F.round(df["gALLfrPub_COIN25"],4))).otherwise(df["rgALLfrPub_COIN25"]))
    df=df.withColumn("rgALLfrRCR_COIN50",F.when(df["gALLfrRCR_COIN50"]>=1000,(F.round(df["gALLfrRCR_COIN50"],0))).otherwise(df["gALLfrRCR_COIN50"]))
    df=df.withColumn("rgALLfrRCR_COIN50",F.when((df["gALLfrRCR_COIN50"]<1000)&(df["gALLfrRCR_COIN50"]>=100),(F.round(df["gALLfrRCR_COIN50"],1))).otherwise(df["rgALLfrRCR_COIN50"]))
    df=df.withColumn("rgALLfrRCR_COIN50",F.when((df["gALLfrRCR_COIN50"]<100)&(df["gALLfrRCR_COIN50"]>=10),(F.round(df["gALLfrRCR_COIN50"],2))).otherwise(df["rgALLfrRCR_COIN50"]))
    df=df.withColumn("rgALLfrRCR_COIN50",F.when((df["gALLfrRCR_COIN50"]<10)&(df["gALLfrRCR_COIN50"]>=1),(F.round(df["gALLfrRCR_COIN50"],3))).otherwise(df["rgALLfrRCR_COIN50"]))
    df=df.withColumn("rgALLfrRCR_COIN50",F.when((df["gALLfrRCR_COIN50"]<1),(F.round(df["gALLfrRCR_COIN50"],4))).otherwise(df["rgALLfrRCR_COIN50"]))
    df=df.withColumn("rgALLfrRCR_COIN75",F.when(df["gALLfrRCR_COIN75"]>=1000,(F.round(df["gALLfrRCR_COIN75"],0))).otherwise(df["gALLfrRCR_COIN75"]))
    df=df.withColumn("rgALLfrRCR_COIN75",F.when((df["gALLfrRCR_COIN75"]<1000)&(df["gALLfrRCR_COIN75"]>=100),(F.round(df["gALLfrRCR_COIN75"],1))).otherwise(df["rgALLfrRCR_COIN75"]))
    df=df.withColumn("rgALLfrRCR_COIN75",F.when((df["gALLfrRCR_COIN75"]<100)&(df["gALLfrRCR_COIN75"]>=10),(F.round(df["gALLfrRCR_COIN75"],2))).otherwise(df["rgALLfrRCR_COIN75"]))
    df=df.withColumn("rgALLfrRCR_COIN75",F.when((df["gALLfrRCR_COIN75"]<10)&(df["gALLfrRCR_COIN75"]>=1),(F.round(df["gALLfrRCR_COIN75"],3))).otherwise(df["rgALLfrRCR_COIN75"]))
    df=df.withColumn("rgALLfrRCR_COIN75",F.when((df["gALLfrRCR_COIN75"]<1),(F.round(df["gALLfrRCR_COIN75"],4))).otherwise(df["rgALLfrRCR_COIN75"]))
    df=df.withColumn("rgALLfrRCR_COIN25",F.when(df["gALLfrRCR_COIN25"]>=1000,(F.round(df["gALLfrRCR_COIN25"],0))).otherwise(df["gALLfrRCR_COIN25"]))
    df=df.withColumn("rgALLfrRCR_COIN25",F.when((df["gALLfrRCR_COIN25"]<1000)&(df["gALLfrRCR_COIN25"]>=100),(F.round(df["gALLfrRCR_COIN25"],1))).otherwise(df["rgALLfrRCR_COIN25"]))
    df=df.withColumn("rgALLfrRCR_COIN25",F.when((df["gALLfrRCR_COIN25"]<100)&(df["gALLfrRCR_COIN25"]>=10),(F.round(df["gALLfrRCR_COIN25"],2))).otherwise(df["rgALLfrRCR_COIN25"]))
    df=df.withColumn("rgALLfrRCR_COIN25",F.when((df["gALLfrRCR_COIN25"]<10)&(df["gALLfrRCR_COIN25"]>=1),(F.round(df["gALLfrRCR_COIN25"],3))).otherwise(df["rgALLfrRCR_COIN25"]))
    df=df.withColumn("rgALLfrRCR_COIN25",F.when((df["gALLfrRCR_COIN25"]<1),(F.round(df["gALLfrRCR_COIN25"],4))).otherwise(df["rgALLfrRCR_COIN25"]))    
    df=df.withColumn("rgGuRawPub_COIN50",F.when(df["gGuRawPub_COIN50"]>=1000,(F.round(df["gGuRawPub_COIN50"],0))).otherwise(df["gGuRawPub_COIN50"]))
    df=df.withColumn("rgGuRawPub_COIN50",F.when((df["gGuRawPub_COIN50"]<1000)&(df["gGuRawPub_COIN50"]>=100),(F.round(df["gGuRawPub_COIN50"],1))).otherwise(df["rgGuRawPub_COIN50"]))
    df=df.withColumn("rgGuRawPub_COIN50",F.when((df["gGuRawPub_COIN50"]<100)&(df["gGuRawPub_COIN50"]>=10),(F.round(df["gGuRawPub_COIN50"],2))).otherwise(df["rgGuRawPub_COIN50"]))
    df=df.withColumn("rgGuRawPub_COIN50",F.when((df["gGuRawPub_COIN50"]<10)&(df["gGuRawPub_COIN50"]>=1),(F.round(df["gGuRawPub_COIN50"],3))).otherwise(df["rgGuRawPub_COIN50"]))
    df=df.withColumn("rgGuRawPub_COIN50",F.when((df["gGuRawPub_COIN50"]<1),(F.round(df["gGuRawPub_COIN50"],4))).otherwise(df["rgGuRawPub_COIN50"]))
    df=df.withColumn("rgGuRawPub_COIN75",F.when(df["gGuRawPub_COIN75"]>=1000,(F.round(df["gGuRawPub_COIN75"],0))).otherwise(df["gGuRawPub_COIN75"]))
    df=df.withColumn("rgGuRawPub_COIN75",F.when((df["gGuRawPub_COIN75"]<1000)&(df["gGuRawPub_COIN75"]>=100),(F.round(df["gGuRawPub_COIN75"],1))).otherwise(df["rgGuRawPub_COIN75"]))
    df=df.withColumn("rgGuRawPub_COIN75",F.when((df["gGuRawPub_COIN75"]<100)&(df["gGuRawPub_COIN75"]>=10),(F.round(df["gGuRawPub_COIN75"],2))).otherwise(df["rgGuRawPub_COIN75"]))
    df=df.withColumn("rgGuRawPub_COIN75",F.when((df["gGuRawPub_COIN75"]<10)&(df["gGuRawPub_COIN75"]>=1),(F.round(df["gGuRawPub_COIN75"],3))).otherwise(df["rgGuRawPub_COIN75"]))
    df=df.withColumn("rgGuRawPub_COIN75",F.when((df["gGuRawPub_COIN75"]<1),(F.round(df["gGuRawPub_COIN75"],4))).otherwise(df["rgGuRawPub_COIN75"]))
    df=df.withColumn("rgGuRawPub_COIN25",F.when(df["gGuRawPub_COIN25"]>=1000,(F.round(df["gGuRawPub_COIN25"],0))).otherwise(df["gGuRawPub_COIN25"]))
    df=df.withColumn("rgGuRawPub_COIN25",F.when((df["gGuRawPub_COIN25"]<1000)&(df["gGuRawPub_COIN25"]>=100),(F.round(df["gGuRawPub_COIN25"],1))).otherwise(df["rgGuRawPub_COIN25"]))
    df=df.withColumn("rgGuRawPub_COIN25",F.when((df["gGuRawPub_COIN25"]<100)&(df["gGuRawPub_COIN25"]>=10),(F.round(df["gGuRawPub_COIN25"],2))).otherwise(df["rgGuRawPub_COIN25"]))
    df=df.withColumn("rgGuRawPub_COIN25",F.when((df["gGuRawPub_COIN25"]<10)&(df["gGuRawPub_COIN25"]>=1),(F.round(df["gGuRawPub_COIN25"],3))).otherwise(df["rgGuRawPub_COIN25"]))
    df=df.withColumn("rgGuRawPub_COIN25",F.when((df["gGuRawPub_COIN25"]<1),(F.round(df["gGuRawPub_COIN25"],4))).otherwise(df["rgGuRawPub_COIN25"]))
    df=df.withColumn("rgGuRawRCR_COIN50",F.when(df["gGuRawRCR_COIN50"]>=1000,(F.round(df["gGuRawRCR_COIN50"],0))).otherwise(df["gGuRawRCR_COIN50"]))
    df=df.withColumn("rgGuRawRCR_COIN50",F.when((df["gGuRawRCR_COIN50"]<1000)&(df["gGuRawRCR_COIN50"]>=100),(F.round(df["gGuRawRCR_COIN50"],1))).otherwise(df["rgGuRawRCR_COIN50"]))
    df=df.withColumn("rgGuRawRCR_COIN50",F.when((df["gGuRawRCR_COIN50"]<100)&(df["gGuRawRCR_COIN50"]>=10),(F.round(df["gGuRawRCR_COIN50"],2))).otherwise(df["rgGuRawRCR_COIN50"]))
    df=df.withColumn("rgGuRawRCR_COIN50",F.when((df["gGuRawRCR_COIN50"]<10)&(df["gGuRawRCR_COIN50"]>=1),(F.round(df["gGuRawRCR_COIN50"],3))).otherwise(df["rgGuRawRCR_COIN50"]))
    df=df.withColumn("rgGuRawRCR_COIN50",F.when((df["gGuRawRCR_COIN50"]<1),(F.round(df["gGuRawRCR_COIN50"],4))).otherwise(df["rgGuRawRCR_COIN50"]))
    df=df.withColumn("rgGuRawRCR_COIN75",F.when(df["gGuRawRCR_COIN75"]>=1000,(F.round(df["gGuRawRCR_COIN75"],0))).otherwise(df["gGuRawRCR_COIN75"]))
    df=df.withColumn("rgGuRawRCR_COIN75",F.when((df["gGuRawRCR_COIN75"]<1000)&(df["gGuRawRCR_COIN75"]>=100),(F.round(df["gGuRawRCR_COIN75"],1))).otherwise(df["rgGuRawRCR_COIN75"]))
    df=df.withColumn("rgGuRawRCR_COIN75",F.when((df["gGuRawRCR_COIN75"]<100)&(df["gGuRawRCR_COIN75"]>=10),(F.round(df["gGuRawRCR_COIN75"],2))).otherwise(df["rgGuRawRCR_COIN75"]))
    df=df.withColumn("rgGuRawRCR_COIN75",F.when((df["gGuRawRCR_COIN75"]<10)&(df["gGuRawRCR_COIN75"]>=1),(F.round(df["gGuRawRCR_COIN75"],3))).otherwise(df["rgGuRawRCR_COIN75"]))
    df=df.withColumn("rgGuRawRCR_COIN75",F.when((df["gGuRawRCR_COIN75"]<1),(F.round(df["gGuRawRCR_COIN75"],4))).otherwise(df["rgGuRawRCR_COIN75"]))
    df=df.withColumn("rgGuRawRCR_COIN25",F.when(df["gGuRawRCR_COIN25"]>=1000,(F.round(df["gGuRawRCR_COIN25"],0))).otherwise(df["gGuRawRCR_COIN25"]))
    df=df.withColumn("rgGuRawRCR_COIN25",F.when((df["gGuRawRCR_COIN25"]<1000)&(df["gGuRawRCR_COIN25"]>=100),(F.round(df["gGuRawRCR_COIN25"],1))).otherwise(df["rgGuRawRCR_COIN25"]))
    df=df.withColumn("rgGuRawRCR_COIN25",F.when((df["gGuRawRCR_COIN25"]<100)&(df["gGuRawRCR_COIN25"]>=10),(F.round(df["gGuRawRCR_COIN25"],2))).otherwise(df["rgGuRawRCR_COIN25"]))
    df=df.withColumn("rgGuRawRCR_COIN25",F.when((df["gGuRawRCR_COIN25"]<10)&(df["gGuRawRCR_COIN25"]>=1),(F.round(df["gGuRawRCR_COIN25"],3))).otherwise(df["rgGuRawRCR_COIN25"]))
    df=df.withColumn("rgGuRawRCR_COIN25",F.when((df["gGuRawRCR_COIN25"]<1),(F.round(df["gGuRawRCR_COIN25"],4))).otherwise(df["rgGuRawRCR_COIN25"]))
    df=df.withColumn("rgGuALLfrPub_COIN50",F.when(df["gGuALLfrPub_COIN50"]>=1000,(F.round(df["gGuALLfrPub_COIN50"],0))).otherwise(df["gGuALLfrPub_COIN50"]))
    df=df.withColumn("rgGuALLfrPub_COIN50",F.when((df["gGuALLfrPub_COIN50"]<1000)&(df["gGuALLfrPub_COIN50"]>=100),(F.round(df["gGuALLfrPub_COIN50"],1))).otherwise(df["rgGuALLfrPub_COIN50"]))
    df=df.withColumn("rgGuALLfrPub_COIN50",F.when((df["gGuALLfrPub_COIN50"]<100)&(df["gGuALLfrPub_COIN50"]>=10),(F.round(df["gGuALLfrPub_COIN50"],2))).otherwise(df["rgGuALLfrPub_COIN50"]))
    df=df.withColumn("rgGuALLfrPub_COIN50",F.when((df["gGuALLfrPub_COIN50"]<10)&(df["gGuALLfrPub_COIN50"]>=1),(F.round(df["gGuALLfrPub_COIN50"],3))).otherwise(df["rgGuALLfrPub_COIN50"]))
    df=df.withColumn("rgGuALLfrPub_COIN50",F.when((df["gGuALLfrPub_COIN50"]<1),(F.round(df["gGuALLfrPub_COIN50"],4))).otherwise(df["rgGuALLfrPub_COIN50"]))
    df=df.withColumn("rgGuALLfrPub_COIN75",F.when(df["gGuALLfrPub_COIN75"]>=1000,(F.round(df["gGuALLfrPub_COIN75"],0))).otherwise(df["gGuALLfrPub_COIN75"]))
    df=df.withColumn("rgGuALLfrPub_COIN75",F.when((df["gGuALLfrPub_COIN75"]<1000)&(df["gGuALLfrPub_COIN75"]>=100),(F.round(df["gGuALLfrPub_COIN75"],1))).otherwise(df["rgGuALLfrPub_COIN75"]))
    df=df.withColumn("rgGuALLfrPub_COIN75",F.when((df["gGuALLfrPub_COIN75"]<100)&(df["gGuALLfrPub_COIN75"]>=10),(F.round(df["gGuALLfrPub_COIN75"],2))).otherwise(df["rgGuALLfrPub_COIN75"]))
    df=df.withColumn("rgGuALLfrPub_COIN75",F.when((df["gGuALLfrPub_COIN75"]<10)&(df["gGuALLfrPub_COIN75"]>=1),(F.round(df["gGuALLfrPub_COIN75"],3))).otherwise(df["rgGuALLfrPub_COIN75"]))
    df=df.withColumn("rgGuALLfrPub_COIN75",F.when((df["gGuALLfrPub_COIN75"]<1),(F.round(df["gGuALLfrPub_COIN75"],4))).otherwise(df["rgGuALLfrPub_COIN75"]))
    df=df.withColumn("rgGuALLfrPub_COIN25",F.when(df["gGuALLfrPub_COIN25"]>=1000,(F.round(df["gGuALLfrPub_COIN25"],0))).otherwise(df["gGuALLfrPub_COIN25"]))
    df=df.withColumn("rgGuALLfrPub_COIN25",F.when((df["gGuALLfrPub_COIN25"]<1000)&(df["gGuALLfrPub_COIN25"]>=100),(F.round(df["gGuALLfrPub_COIN25"],1))).otherwise(df["rgGuALLfrPub_COIN25"]))
    df=df.withColumn("rgGuALLfrPub_COIN25",F.when((df["gGuALLfrPub_COIN25"]<100)&(df["gGuALLfrPub_COIN25"]>=10),(F.round(df["gGuALLfrPub_COIN25"],2))).otherwise(df["rgGuALLfrPub_COIN25"]))
    df=df.withColumn("rgGuALLfrPub_COIN25",F.when((df["gGuALLfrPub_COIN25"]<10)&(df["gGuALLfrPub_COIN25"]>=1),(F.round(df["gGuALLfrPub_COIN25"],3))).otherwise(df["rgGuALLfrPub_COIN25"]))
    df=df.withColumn("rgGuALLfrPub_COIN25",F.when((df["gGuALLfrPub_COIN25"]<1),(F.round(df["gGuALLfrPub_COIN25"],4))).otherwise(df["rgGuALLfrPub_COIN25"]))
    df=df.withColumn("rgGuALLfrRCR_COIN50",F.when(df["gGuALLfrRCR_COIN50"]>=1000,(F.round(df["gGuALLfrRCR_COIN50"],0))).otherwise(df["gGuALLfrRCR_COIN50"]))
    df=df.withColumn("rgGuALLfrRCR_COIN50",F.when((df["gGuALLfrRCR_COIN50"]<1000)&(df["gGuALLfrRCR_COIN50"]>=100),(F.round(df["gGuALLfrRCR_COIN50"],1))).otherwise(df["rgGuALLfrRCR_COIN50"]))
    df=df.withColumn("rgGuALLfrRCR_COIN50",F.when((df["gGuALLfrRCR_COIN50"]<100)&(df["gGuALLfrRCR_COIN50"]>=10),(F.round(df["gGuALLfrRCR_COIN50"],2))).otherwise(df["rgGuALLfrRCR_COIN50"]))
    df=df.withColumn("rgGuALLfrRCR_COIN50",F.when((df["gGuALLfrRCR_COIN50"]<10)&(df["gGuALLfrRCR_COIN50"]>=1),(F.round(df["gGuALLfrRCR_COIN50"],3))).otherwise(df["rgGuALLfrRCR_COIN50"]))
    df=df.withColumn("rgGuALLfrRCR_COIN50",F.when((df["gGuALLfrRCR_COIN50"]<1),(F.round(df["gGuALLfrRCR_COIN50"],4))).otherwise(df["rgGuALLfrRCR_COIN50"]))
    df=df.withColumn("rgGuALLfrRCR_COIN75",F.when(df["gGuALLfrRCR_COIN75"]>=1000,(F.round(df["gGuALLfrRCR_COIN75"],0))).otherwise(df["gGuALLfrRCR_COIN75"]))
    df=df.withColumn("rgGuALLfrRCR_COIN75",F.when((df["gGuALLfrRCR_COIN75"]<1000)&(df["gGuALLfrRCR_COIN75"]>=100),(F.round(df["gGuALLfrRCR_COIN75"],1))).otherwise(df["rgGuALLfrRCR_COIN75"]))
    df=df.withColumn("rgGuALLfrRCR_COIN75",F.when((df["gGuALLfrRCR_COIN75"]<100)&(df["gGuALLfrRCR_COIN75"]>=10),(F.round(df["gGuALLfrRCR_COIN75"],2))).otherwise(df["rgGuALLfrRCR_COIN75"]))
    df=df.withColumn("rgGuALLfrRCR_COIN75",F.when((df["gGuALLfrRCR_COIN75"]<10)&(df["gGuALLfrRCR_COIN75"]>=1),(F.round(df["gGuALLfrRCR_COIN75"],3))).otherwise(df["rgGuALLfrRCR_COIN75"]))
    df=df.withColumn("rgGuALLfrRCR_COIN75",F.when((df["gGuALLfrRCR_COIN75"]<1),(F.round(df["gGuALLfrRCR_COIN75"],4))).otherwise(df["rgGuALLfrRCR_COIN75"]))
    df=df.withColumn("rgGuALLfrRCR_COIN25",F.when(df["gGuALLfrRCR_COIN25"]>=1000,(F.round(df["gGuALLfrRCR_COIN25"],0))).otherwise(df["gGuALLfrRCR_COIN25"]))
    df=df.withColumn("rgGuALLfrRCR_COIN25",F.when((df["gGuALLfrRCR_COIN25"]<1000)&(df["gGuALLfrRCR_COIN25"]>=100),(F.round(df["gGuALLfrRCR_COIN25"],1))).otherwise(df["rgGuALLfrRCR_COIN25"]))
    df=df.withColumn("rgGuALLfrRCR_COIN25",F.when((df["gGuALLfrRCR_COIN25"]<100)&(df["gGuALLfrRCR_COIN25"]>=10),(F.round(df["gGuALLfrRCR_COIN25"],2))).otherwise(df["rgGuALLfrRCR_COIN25"]))
    df=df.withColumn("rgGuALLfrRCR_COIN25",F.when((df["gGuALLfrRCR_COIN25"]<10)&(df["gGuALLfrRCR_COIN25"]>=1),(F.round(df["gGuALLfrRCR_COIN25"],3))).otherwise(df["rgGuALLfrRCR_COIN25"]))
    df=df.withColumn("rgGuALLfrRCR_COIN25",F.when((df["gGuALLfrRCR_COIN25"]<1),(F.round(df["gGuALLfrRCR_COIN25"],4))).otherwise(df["rgGuALLfrRCR_COIN25"])) 
    df=df.select("G1","G2","N_COUNT","TC","rgRawPub_COIN50","rgRawPub_COIN75","rgRawPub_COIN25","rgRawRCR_COIN50","rgRawRCR_COIN75","rgRawRCR_COIN25","rgALLfrPub_COIN50","rgALLfrPub_COIN75","rgALLfrPub_COIN25","rgALLfrRCR_COIN50","rgALLfrRCR_COIN75","rgALLfrRCR_COIN25","rgGuRawPub_COIN50","rgGuRawPub_COIN75","rgGuRawPub_COIN25","rgGuRawRCR_COIN50","rgGuRawRCR_COIN75","rgGuRawRCR_COIN25","rgGuALLfrPub_COIN50","rgGuALLfrPub_COIN75","rgGuALLfrPub_COIN25","rgGuALLfrRCR_COIN50","rgGuALLfrRCR_COIN75","rgGuALLfrRCR_COIN25") 
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.7432ea51-0e5a-4bad-aaed-baca6e866ea5"),
    INV_COIN_CALC=Input(rid="ri.foundry.main.dataset.960592bc-f64b-46dc-a41d-3df9a984446a")
)
from pyspark.sql import functions as F
def MEDIAN_INV_COIN(INV_COIN_CALC):
    df=INV_COIN_CALC
    df=df.withColumn("Inv_COUNT",F.lit(1))
    df=df.groupBy("G1_").agg(F.percentile_approx("Pub_CC",0.5).alias("iRawPub_COIN50"),F.percentile_approx("Pub_CC",0.75).alias("iRawPub_COIN75"),F.percentile_approx("Pub_CC",0.25).alias("iRawPub_COIN25"),F.percentile_approx("RCR_CC",0.5).alias("iRawRCR_COIN50"),F.percentile_approx("RCR_CC",0.75).alias("iRawRCR_COIN75"),F.percentile_approx("RCR_CC",0.25).alias("iRawRCR_COIN25"),F.percentile_approx("PubPerALLGrFAuF_CC",0.5).alias("iAuALLfrPub_COIN50"),F.percentile_approx("PubPerALLGrFAuF_CC",0.75).alias("iAuALLfrPub_COIN75"),F.percentile_approx("PubPerALLGrFAuF_CC",0.25).alias("iAuALLfrPub_COIN25"),F.percentile_approx("RCRperALLGrFAuF_CC",0.5).alias("iAuALLfrRCR_COIN50"),F.percentile_approx("RCRperALLGrFAuF_CC",0.75).alias("iAuALLfrRCR_COIN75"),F.percentile_approx("RCRperALLGrFAuF_CC",0.25).alias("iAuALLfrRCR_COIN25"),F.percentile_approx("GuCitedPub_CC",0.5).alias("iGuRawPub_COIN50"),F.percentile_approx("GuCitedPub_CC",0.75).alias("iGuRawPub_COIN75"),F.percentile_approx("GuCitedPub_CC",0.25).alias("iGuRawPub_COIN25"),F.percentile_approx("GuRCRofCitedPub_CC",0.5).alias("iGuRawRCR_COIN50"),F.percentile_approx("GuRCRofCitedPub_CC",0.75).alias("iGuRawRCR_COIN75"),F.percentile_approx("GuRCRofCitedPub_CC",0.25).alias("iGuRawRCR_COIN25"),F.percentile_approx("GuPubPerALLGrAuF_CC",0.5).alias("iGuAuALLfrPub_COIN50"),F.percentile_approx("GuPubPerALLGrAuF_CC",0.75).alias("iGuAuALLfrPub_COIN75"),F.percentile_approx("GuPubPerALLGrAuF_CC",0.25).alias("iGuAuALLfrPub_COIN25"),F.percentile_approx("GuRCRperALLGrAuF_CC",0.5).alias("iGuAuALLfrRCR_COIN50"),F.percentile_approx("GuRCRperALLGrAuF_CC",0.75).alias("iGuAuALLfrRCR_COIN75"),F.percentile_approx("GuRCRperALLGrAuF_CC",0.25).alias("iGuAuALLfrRCR_COIN25"),F.sum(df["Inv_COUNT"]).alias("N_COUNT"),F.sum(df["InvestigatorTC"]).alias("TC"))
    df=df.withColumn("riRawPub_COIN50",F.when(df["iRawPub_COIN50"]>=1000,(F.round(df["iRawPub_COIN50"],0))).otherwise(df["iRawPub_COIN50"]))
    df=df.withColumn("riRawPub_COIN50",F.when((df["iRawPub_COIN50"]<1000)&(df["iRawPub_COIN50"]>=100),(F.round(df["iRawPub_COIN50"],1))).otherwise(df["riRawPub_COIN50"]))
    df=df.withColumn("riRawPub_COIN50",F.when((df["iRawPub_COIN50"]<100)&(df["iRawPub_COIN50"]>=10),(F.round(df["iRawPub_COIN50"],2))).otherwise(df["riRawPub_COIN50"]))
    df=df.withColumn("riRawPub_COIN50",F.when((df["iRawPub_COIN50"]<10)&(df["iRawPub_COIN50"]>=1),(F.round(df["iRawPub_COIN50"],3))).otherwise(df["riRawPub_COIN50"]))
    df=df.withColumn("riRawPub_COIN50",F.when((df["iRawPub_COIN50"]<1),(F.round(df["iRawPub_COIN50"],4))).otherwise(df["riRawPub_COIN50"]))
    df=df.withColumn("riRawPub_COIN75",F.when(df["iRawPub_COIN75"]>=1000,(F.round(df["iRawPub_COIN75"],0))).otherwise(df["iRawPub_COIN75"]))
    df=df.withColumn("riRawPub_COIN75",F.when((df["iRawPub_COIN75"]<1000)&(df["iRawPub_COIN75"]>=100),(F.round(df["iRawPub_COIN75"],1))).otherwise(df["riRawPub_COIN75"]))
    df=df.withColumn("riRawPub_COIN75",F.when((df["iRawPub_COIN75"]<100)&(df["iRawPub_COIN75"]>=10),(F.round(df["iRawPub_COIN75"],2))).otherwise(df["riRawPub_COIN75"]))
    df=df.withColumn("riRawPub_COIN75",F.when((df["iRawPub_COIN75"]<10)&(df["iRawPub_COIN75"]>=1),(F.round(df["iRawPub_COIN75"],3))).otherwise(df["riRawPub_COIN75"]))
    df=df.withColumn("riRawPub_COIN75",F.when((df["iRawPub_COIN75"]<1),(F.round(df["iRawPub_COIN75"],4))).otherwise(df["riRawPub_COIN75"]))
    df=df.withColumn("riRawPub_COIN25",F.when(df["iRawPub_COIN25"]>=1000,(F.round(df["iRawPub_COIN25"],0))).otherwise(df["iRawPub_COIN25"]))
    df=df.withColumn("riRawPub_COIN25",F.when((df["iRawPub_COIN25"]<1000)&(df["iRawPub_COIN25"]>=100),(F.round(df["iRawPub_COIN25"],1))).otherwise(df["riRawPub_COIN25"]))
    df=df.withColumn("riRawPub_COIN25",F.when((df["iRawPub_COIN25"]<100)&(df["iRawPub_COIN25"]>=10),(F.round(df["iRawPub_COIN25"],2))).otherwise(df["riRawPub_COIN25"]))
    df=df.withColumn("riRawPub_COIN25",F.when((df["iRawPub_COIN25"]<10)&(df["iRawPub_COIN25"]>=1),(F.round(df["iRawPub_COIN25"],3))).otherwise(df["riRawPub_COIN25"]))
    df=df.withColumn("riRawPub_COIN25",F.when((df["iRawPub_COIN25"]<1),(F.round(df["iRawPub_COIN25"],4))).otherwise(df["riRawPub_COIN25"]))
    df=df.withColumn("riRawRCR_COIN50",F.when(df["iRawRCR_COIN50"]>=1000,(F.round(df["iRawRCR_COIN50"],0))).otherwise(df["iRawRCR_COIN50"]))
    df=df.withColumn("riRawRCR_COIN50",F.when((df["iRawRCR_COIN50"]<1000)&(df["iRawRCR_COIN50"]>=100),(F.round(df["iRawRCR_COIN50"],1))).otherwise(df["riRawRCR_COIN50"]))
    df=df.withColumn("riRawRCR_COIN50",F.when((df["iRawRCR_COIN50"]<100)&(df["iRawRCR_COIN50"]>=10),(F.round(df["iRawRCR_COIN50"],2))).otherwise(df["riRawRCR_COIN50"]))
    df=df.withColumn("riRawRCR_COIN50",F.when((df["iRawRCR_COIN50"]<10)&(df["iRawRCR_COIN50"]>=1),(F.round(df["iRawRCR_COIN50"],3))).otherwise(df["riRawRCR_COIN50"]))
    df=df.withColumn("riRawRCR_COIN50",F.when((df["iRawRCR_COIN50"]<1),(F.round(df["iRawRCR_COIN50"],4))).otherwise(df["riRawRCR_COIN50"]))
    df=df.withColumn("riRawRCR_COIN75",F.when(df["iRawRCR_COIN75"]>=1000,(F.round(df["iRawRCR_COIN75"],0))).otherwise(df["iRawRCR_COIN75"]))
    df=df.withColumn("riRawRCR_COIN75",F.when((df["iRawRCR_COIN75"]<1000)&(df["iRawRCR_COIN75"]>=100),(F.round(df["iRawRCR_COIN75"],1))).otherwise(df["riRawRCR_COIN75"]))
    df=df.withColumn("riRawRCR_COIN75",F.when((df["iRawRCR_COIN75"]<100)&(df["iRawRCR_COIN75"]>=10),(F.round(df["iRawRCR_COIN75"],2))).otherwise(df["riRawRCR_COIN75"]))
    df=df.withColumn("riRawRCR_COIN75",F.when((df["iRawRCR_COIN75"]<10)&(df["iRawRCR_COIN75"]>=1),(F.round(df["iRawRCR_COIN75"],3))).otherwise(df["riRawRCR_COIN75"]))
    df=df.withColumn("riRawRCR_COIN75",F.when((df["iRawRCR_COIN75"]<1),(F.round(df["iRawRCR_COIN75"],4))).otherwise(df["riRawRCR_COIN75"]))
    df=df.withColumn("riRawRCR_COIN25",F.when(df["iRawRCR_COIN25"]>=1000,(F.round(df["iRawRCR_COIN25"],0))).otherwise(df["iRawRCR_COIN25"]))
    df=df.withColumn("riRawRCR_COIN25",F.when((df["iRawRCR_COIN25"]<1000)&(df["iRawRCR_COIN25"]>=100),(F.round(df["iRawRCR_COIN25"],1))).otherwise(df["riRawRCR_COIN25"]))
    df=df.withColumn("riRawRCR_COIN25",F.when((df["iRawRCR_COIN25"]<100)&(df["iRawRCR_COIN25"]>=10),(F.round(df["iRawRCR_COIN25"],2))).otherwise(df["riRawRCR_COIN25"]))
    df=df.withColumn("riRawRCR_COIN25",F.when((df["iRawRCR_COIN25"]<10)&(df["iRawRCR_COIN25"]>=1),(F.round(df["iRawRCR_COIN25"],3))).otherwise(df["riRawRCR_COIN25"]))
    df=df.withColumn("riRawRCR_COIN25",F.when((df["iRawRCR_COIN25"]<1),(F.round(df["iRawRCR_COIN25"],4))).otherwise(df["riRawRCR_COIN25"]))
    df=df.withColumn("riAuALLfrPub_COIN50",F.when(df["iAuALLfrPub_COIN50"]>=1000,(F.round(df["iAuALLfrPub_COIN50"],0))).otherwise(df["iAuALLfrPub_COIN50"]))
    df=df.withColumn("riAuALLfrPub_COIN50",F.when((df["iAuALLfrPub_COIN50"]<1000)&(df["iAuALLfrPub_COIN50"]>=100),(F.round(df["iAuALLfrPub_COIN50"],1))).otherwise(df["riAuALLfrPub_COIN50"]))
    df=df.withColumn("riAuALLfrPub_COIN50",F.when((df["iAuALLfrPub_COIN50"]<100)&(df["iAuALLfrPub_COIN50"]>=10),(F.round(df["iAuALLfrPub_COIN50"],2))).otherwise(df["riAuALLfrPub_COIN50"]))
    df=df.withColumn("riAuALLfrPub_COIN50",F.when((df["iAuALLfrPub_COIN50"]<10)&(df["iAuALLfrPub_COIN50"]>=1),(F.round(df["iAuALLfrPub_COIN50"],3))).otherwise(df["riAuALLfrPub_COIN50"]))
    df=df.withColumn("riAuALLfrPub_COIN50",F.when((df["iAuALLfrPub_COIN50"]<1),(F.round(df["iAuALLfrPub_COIN50"],4))).otherwise(df["riAuALLfrPub_COIN50"]))
    df=df.withColumn("riAuALLfrPub_COIN75",F.when(df["iAuALLfrPub_COIN75"]>=1000,(F.round(df["iAuALLfrPub_COIN75"],0))).otherwise(df["iAuALLfrPub_COIN75"]))
    df=df.withColumn("riAuALLfrPub_COIN75",F.when((df["iAuALLfrPub_COIN75"]<1000)&(df["iAuALLfrPub_COIN75"]>=100),(F.round(df["iAuALLfrPub_COIN75"],1))).otherwise(df["riAuALLfrPub_COIN75"]))
    df=df.withColumn("riAuALLfrPub_COIN75",F.when((df["iAuALLfrPub_COIN75"]<100)&(df["iAuALLfrPub_COIN75"]>=10),(F.round(df["iAuALLfrPub_COIN75"],2))).otherwise(df["riAuALLfrPub_COIN75"]))
    df=df.withColumn("riAuALLfrPub_COIN75",F.when((df["iAuALLfrPub_COIN75"]<10)&(df["iAuALLfrPub_COIN75"]>=1),(F.round(df["iAuALLfrPub_COIN75"],3))).otherwise(df["riAuALLfrPub_COIN75"]))
    df=df.withColumn("riAuALLfrPub_COIN75",F.when((df["iAuALLfrPub_COIN75"]<1),(F.round(df["iAuALLfrPub_COIN75"],4))).otherwise(df["riAuALLfrPub_COIN75"]))
    df=df.withColumn("riAuALLfrPub_COIN25",F.when(df["iAuALLfrPub_COIN25"]>=1000,(F.round(df["iAuALLfrPub_COIN25"],0))).otherwise(df["iAuALLfrPub_COIN25"]))
    df=df.withColumn("riAuALLfrPub_COIN25",F.when((df["iAuALLfrPub_COIN25"]<1000)&(df["iAuALLfrPub_COIN25"]>=100),(F.round(df["iAuALLfrPub_COIN25"],1))).otherwise(df["riAuALLfrPub_COIN25"]))
    df=df.withColumn("riAuALLfrPub_COIN25",F.when((df["iAuALLfrPub_COIN25"]<100)&(df["iAuALLfrPub_COIN25"]>=10),(F.round(df["iAuALLfrPub_COIN25"],2))).otherwise(df["riAuALLfrPub_COIN25"]))
    df=df.withColumn("riAuALLfrPub_COIN25",F.when((df["iAuALLfrPub_COIN25"]<10)&(df["iAuALLfrPub_COIN25"]>=1),(F.round(df["iAuALLfrPub_COIN25"],3))).otherwise(df["riAuALLfrPub_COIN25"]))
    df=df.withColumn("riAuALLfrPub_COIN25",F.when((df["iAuALLfrPub_COIN25"]<1),(F.round(df["iAuALLfrPub_COIN25"],4))).otherwise(df["riAuALLfrPub_COIN25"]))
    df=df.withColumn("riAuALLfrRCR_COIN50",F.when(df["iAuALLfrRCR_COIN50"]>=1000,(F.round(df["iAuALLfrRCR_COIN50"],0))).otherwise(df["iAuALLfrRCR_COIN50"]))
    df=df.withColumn("riAuALLfrRCR_COIN50",F.when((df["iAuALLfrRCR_COIN50"]<1000)&(df["iAuALLfrRCR_COIN50"]>=100),(F.round(df["iAuALLfrRCR_COIN50"],1))).otherwise(df["riAuALLfrRCR_COIN50"]))
    df=df.withColumn("riAuALLfrRCR_COIN50",F.when((df["iAuALLfrRCR_COIN50"]<100)&(df["iAuALLfrRCR_COIN50"]>=10),(F.round(df["iAuALLfrRCR_COIN50"],2))).otherwise(df["riAuALLfrRCR_COIN50"]))
    df=df.withColumn("riAuALLfrRCR_COIN50",F.when((df["iAuALLfrRCR_COIN50"]<10)&(df["iAuALLfrRCR_COIN50"]>=1),(F.round(df["iAuALLfrRCR_COIN50"],3))).otherwise(df["riAuALLfrRCR_COIN50"]))
    df=df.withColumn("riAuALLfrRCR_COIN50",F.when((df["iAuALLfrRCR_COIN50"]<1),(F.round(df["iAuALLfrRCR_COIN50"],4))).otherwise(df["riAuALLfrRCR_COIN50"]))
    df=df.withColumn("riAuALLfrRCR_COIN75",F.when(df["iAuALLfrRCR_COIN75"]>=1000,(F.round(df["iAuALLfrRCR_COIN75"],0))).otherwise(df["iAuALLfrRCR_COIN75"]))
    df=df.withColumn("riAuALLfrRCR_COIN75",F.when((df["iAuALLfrRCR_COIN75"]<1000)&(df["iAuALLfrRCR_COIN75"]>=100),(F.round(df["iAuALLfrRCR_COIN75"],1))).otherwise(df["riAuALLfrRCR_COIN75"]))
    df=df.withColumn("riAuALLfrRCR_COIN75",F.when((df["iAuALLfrRCR_COIN75"]<100)&(df["iAuALLfrRCR_COIN75"]>=10),(F.round(df["iAuALLfrRCR_COIN75"],2))).otherwise(df["riAuALLfrRCR_COIN75"]))
    df=df.withColumn("riAuALLfrRCR_COIN75",F.when((df["iAuALLfrRCR_COIN75"]<10)&(df["iAuALLfrRCR_COIN75"]>=1),(F.round(df["iAuALLfrRCR_COIN75"],3))).otherwise(df["riAuALLfrRCR_COIN75"]))
    df=df.withColumn("riAuALLfrRCR_COIN75",F.when((df["iAuALLfrRCR_COIN75"]<1),(F.round(df["iAuALLfrRCR_COIN75"],4))).otherwise(df["riAuALLfrRCR_COIN75"]))
    df=df.withColumn("riAuALLfrRCR_COIN25",F.when(df["iAuALLfrRCR_COIN25"]>=1000,(F.round(df["iAuALLfrRCR_COIN25"],0))).otherwise(df["iAuALLfrRCR_COIN25"]))
    df=df.withColumn("riAuALLfrRCR_COIN25",F.when((df["iAuALLfrRCR_COIN25"]<1000)&(df["iAuALLfrRCR_COIN25"]>=100),(F.round(df["iAuALLfrRCR_COIN25"],1))).otherwise(df["riAuALLfrRCR_COIN25"]))
    df=df.withColumn("riAuALLfrRCR_COIN25",F.when((df["iAuALLfrRCR_COIN25"]<100)&(df["iAuALLfrRCR_COIN25"]>=10),(F.round(df["iAuALLfrRCR_COIN25"],2))).otherwise(df["riAuALLfrRCR_COIN25"]))
    df=df.withColumn("riAuALLfrRCR_COIN25",F.when((df["iAuALLfrRCR_COIN25"]<10)&(df["iAuALLfrRCR_COIN25"]>=1),(F.round(df["iAuALLfrRCR_COIN25"],3))).otherwise(df["riAuALLfrRCR_COIN25"]))
    df=df.withColumn("riAuALLfrRCR_COIN25",F.when((df["iAuALLfrRCR_COIN25"]<1),(F.round(df["iAuALLfrRCR_COIN25"],4))).otherwise(df["riAuALLfrRCR_COIN25"]))    
    df=df.withColumn("riGuRawPub_COIN50",F.when(df["iGuRawPub_COIN50"]>=1000,(F.round(df["iGuRawPub_COIN50"],0))).otherwise(df["iGuRawPub_COIN50"]))
    df=df.withColumn("riGuRawPub_COIN50",F.when((df["iGuRawPub_COIN50"]<1000)&(df["iGuRawPub_COIN50"]>=100),(F.round(df["iGuRawPub_COIN50"],1))).otherwise(df["riGuRawPub_COIN50"]))
    df=df.withColumn("riGuRawPub_COIN50",F.when((df["iGuRawPub_COIN50"]<100)&(df["iGuRawPub_COIN50"]>=10),(F.round(df["iGuRawPub_COIN50"],2))).otherwise(df["riGuRawPub_COIN50"]))
    df=df.withColumn("riGuRawPub_COIN50",F.when((df["iGuRawPub_COIN50"]<10)&(df["iGuRawPub_COIN50"]>=1),(F.round(df["iGuRawPub_COIN50"],3))).otherwise(df["riGuRawPub_COIN50"]))
    df=df.withColumn("riGuRawPub_COIN50",F.when((df["iGuRawPub_COIN50"]<1),(F.round(df["iGuRawPub_COIN50"],4))).otherwise(df["riGuRawPub_COIN50"]))
    df=df.withColumn("riGuRawPub_COIN75",F.when(df["iGuRawPub_COIN75"]>=1000,(F.round(df["iGuRawPub_COIN75"],0))).otherwise(df["iGuRawPub_COIN75"]))
    df=df.withColumn("riGuRawPub_COIN75",F.when((df["iGuRawPub_COIN75"]<1000)&(df["iGuRawPub_COIN75"]>=100),(F.round(df["iGuRawPub_COIN75"],1))).otherwise(df["riGuRawPub_COIN75"]))
    df=df.withColumn("riGuRawPub_COIN75",F.when((df["iGuRawPub_COIN75"]<100)&(df["iGuRawPub_COIN75"]>=10),(F.round(df["iGuRawPub_COIN75"],2))).otherwise(df["riGuRawPub_COIN75"]))
    df=df.withColumn("riGuRawPub_COIN75",F.when((df["iGuRawPub_COIN75"]<10)&(df["iGuRawPub_COIN75"]>=1),(F.round(df["iGuRawPub_COIN75"],3))).otherwise(df["riGuRawPub_COIN75"]))
    df=df.withColumn("riGuRawPub_COIN75",F.when((df["iGuRawPub_COIN75"]<1),(F.round(df["iGuRawPub_COIN75"],4))).otherwise(df["riGuRawPub_COIN75"]))
    df=df.withColumn("riGuRawPub_COIN25",F.when(df["iGuRawPub_COIN25"]>=1000,(F.round(df["iGuRawPub_COIN25"],0))).otherwise(df["iGuRawPub_COIN25"]))
    df=df.withColumn("riGuRawPub_COIN25",F.when((df["iGuRawPub_COIN25"]<1000)&(df["iGuRawPub_COIN25"]>=100),(F.round(df["iGuRawPub_COIN25"],1))).otherwise(df["riGuRawPub_COIN25"]))
    df=df.withColumn("riGuRawPub_COIN25",F.when((df["iGuRawPub_COIN25"]<100)&(df["iGuRawPub_COIN25"]>=10),(F.round(df["iGuRawPub_COIN25"],2))).otherwise(df["riGuRawPub_COIN25"]))
    df=df.withColumn("riGuRawPub_COIN25",F.when((df["iGuRawPub_COIN25"]<10)&(df["iGuRawPub_COIN25"]>=1),(F.round(df["iGuRawPub_COIN25"],3))).otherwise(df["riGuRawPub_COIN25"]))
    df=df.withColumn("riGuRawPub_COIN25",F.when((df["iGuRawPub_COIN25"]<1),(F.round(df["iGuRawPub_COIN25"],4))).otherwise(df["riGuRawPub_COIN25"]))
    df=df.withColumn("riGuRawRCR_COIN50",F.when(df["iGuRawRCR_COIN50"]>=1000,(F.round(df["iGuRawRCR_COIN50"],0))).otherwise(df["iGuRawRCR_COIN50"]))
    df=df.withColumn("riGuRawRCR_COIN50",F.when((df["iGuRawRCR_COIN50"]<1000)&(df["iGuRawRCR_COIN50"]>=100),(F.round(df["iGuRawRCR_COIN50"],1))).otherwise(df["riGuRawRCR_COIN50"]))
    df=df.withColumn("riGuRawRCR_COIN50",F.when((df["iGuRawRCR_COIN50"]<100)&(df["iGuRawRCR_COIN50"]>=10),(F.round(df["iGuRawRCR_COIN50"],2))).otherwise(df["riGuRawRCR_COIN50"]))
    df=df.withColumn("riGuRawRCR_COIN50",F.when((df["iGuRawRCR_COIN50"]<10)&(df["iGuRawRCR_COIN50"]>=1),(F.round(df["iGuRawRCR_COIN50"],3))).otherwise(df["riGuRawRCR_COIN50"]))
    df=df.withColumn("riGuRawRCR_COIN50",F.when((df["iGuRawRCR_COIN50"]<1),(F.round(df["iGuRawRCR_COIN50"],4))).otherwise(df["riGuRawRCR_COIN50"]))
    df=df.withColumn("riGuRawRCR_COIN75",F.when(df["iGuRawRCR_COIN75"]>=1000,(F.round(df["iGuRawRCR_COIN75"],0))).otherwise(df["iGuRawRCR_COIN75"]))
    df=df.withColumn("riGuRawRCR_COIN75",F.when((df["iGuRawRCR_COIN75"]<1000)&(df["iGuRawRCR_COIN75"]>=100),(F.round(df["iGuRawRCR_COIN75"],1))).otherwise(df["riGuRawRCR_COIN75"]))
    df=df.withColumn("riGuRawRCR_COIN75",F.when((df["iGuRawRCR_COIN75"]<100)&(df["iGuRawRCR_COIN75"]>=10),(F.round(df["iGuRawRCR_COIN75"],2))).otherwise(df["riGuRawRCR_COIN75"]))
    df=df.withColumn("riGuRawRCR_COIN75",F.when((df["iGuRawRCR_COIN75"]<10)&(df["iGuRawRCR_COIN75"]>=1),(F.round(df["iGuRawRCR_COIN75"],3))).otherwise(df["riGuRawRCR_COIN75"]))
    df=df.withColumn("riGuRawRCR_COIN75",F.when((df["iGuRawRCR_COIN75"]<1),(F.round(df["iGuRawRCR_COIN75"],4))).otherwise(df["riGuRawRCR_COIN75"]))
    df=df.withColumn("riGuRawRCR_COIN25",F.when(df["iGuRawRCR_COIN25"]>=1000,(F.round(df["iGuRawRCR_COIN25"],0))).otherwise(df["iGuRawRCR_COIN25"]))
    df=df.withColumn("riGuRawRCR_COIN25",F.when((df["iGuRawRCR_COIN25"]<1000)&(df["iGuRawRCR_COIN25"]>=100),(F.round(df["iGuRawRCR_COIN25"],1))).otherwise(df["riGuRawRCR_COIN25"]))
    df=df.withColumn("riGuRawRCR_COIN25",F.when((df["iGuRawRCR_COIN25"]<100)&(df["iGuRawRCR_COIN25"]>=10),(F.round(df["iGuRawRCR_COIN25"],2))).otherwise(df["riGuRawRCR_COIN25"]))
    df=df.withColumn("riGuRawRCR_COIN25",F.when((df["iGuRawRCR_COIN25"]<10)&(df["iGuRawRCR_COIN25"]>=1),(F.round(df["iGuRawRCR_COIN25"],3))).otherwise(df["riGuRawRCR_COIN25"]))
    df=df.withColumn("riGuRawRCR_COIN25",F.when((df["iGuRawRCR_COIN25"]<1),(F.round(df["iGuRawRCR_COIN25"],4))).otherwise(df["riGuRawRCR_COIN25"]))
    df=df.withColumn("riGuAuALLfrPub_COIN50",F.when(df["iGuAuALLfrPub_COIN50"]>=1000,(F.round(df["iGuAuALLfrPub_COIN50"],0))).otherwise(df["iGuAuALLfrPub_COIN50"]))
    df=df.withColumn("riGuAuALLfrPub_COIN50",F.when((df["iGuAuALLfrPub_COIN50"]<1000)&(df["iGuAuALLfrPub_COIN50"]>=100),(F.round(df["iGuAuALLfrPub_COIN50"],1))).otherwise(df["riGuAuALLfrPub_COIN50"]))
    df=df.withColumn("riGuAuALLfrPub_COIN50",F.when((df["iGuAuALLfrPub_COIN50"]<100)&(df["iGuAuALLfrPub_COIN50"]>=10),(F.round(df["iGuAuALLfrPub_COIN50"],2))).otherwise(df["riGuAuALLfrPub_COIN50"]))
    df=df.withColumn("riGuAuALLfrPub_COIN50",F.when((df["iGuAuALLfrPub_COIN50"]<10)&(df["iGuAuALLfrPub_COIN50"]>=1),(F.round(df["iGuAuALLfrPub_COIN50"],3))).otherwise(df["riGuAuALLfrPub_COIN50"]))
    df=df.withColumn("riGuAuALLfrPub_COIN50",F.when((df["iGuAuALLfrPub_COIN50"]<1),(F.round(df["iGuAuALLfrPub_COIN50"],4))).otherwise(df["riGuAuALLfrPub_COIN50"]))
    df=df.withColumn("riGuAuALLfrPub_COIN75",F.when(df["iGuAuALLfrPub_COIN75"]>=1000,(F.round(df["iGuAuALLfrPub_COIN75"],0))).otherwise(df["iGuAuALLfrPub_COIN75"]))
    df=df.withColumn("riGuAuALLfrPub_COIN75",F.when((df["iGuAuALLfrPub_COIN75"]<1000)&(df["iGuAuALLfrPub_COIN75"]>=100),(F.round(df["iGuAuALLfrPub_COIN75"],1))).otherwise(df["riGuAuALLfrPub_COIN75"]))
    df=df.withColumn("riGuAuALLfrPub_COIN75",F.when((df["iGuAuALLfrPub_COIN75"]<100)&(df["iGuAuALLfrPub_COIN75"]>=10),(F.round(df["iGuAuALLfrPub_COIN75"],2))).otherwise(df["riGuAuALLfrPub_COIN75"]))
    df=df.withColumn("riGuAuALLfrPub_COIN75",F.when((df["iGuAuALLfrPub_COIN75"]<10)&(df["iGuAuALLfrPub_COIN75"]>=1),(F.round(df["iGuAuALLfrPub_COIN75"],3))).otherwise(df["riGuAuALLfrPub_COIN75"]))
    df=df.withColumn("riGuAuALLfrPub_COIN75",F.when((df["iGuAuALLfrPub_COIN75"]<1),(F.round(df["iGuAuALLfrPub_COIN75"],4))).otherwise(df["riGuAuALLfrPub_COIN75"]))
    df=df.withColumn("riGuAuALLfrPub_COIN25",F.when(df["iGuAuALLfrPub_COIN25"]>=1000,(F.round(df["iGuAuALLfrPub_COIN25"],0))).otherwise(df["iGuAuALLfrPub_COIN25"]))
    df=df.withColumn("riGuAuALLfrPub_COIN25",F.when((df["iGuAuALLfrPub_COIN25"]<1000)&(df["iGuAuALLfrPub_COIN25"]>=100),(F.round(df["iGuAuALLfrPub_COIN25"],1))).otherwise(df["riGuAuALLfrPub_COIN25"]))
    df=df.withColumn("riGuAuALLfrPub_COIN25",F.when((df["iGuAuALLfrPub_COIN25"]<100)&(df["iGuAuALLfrPub_COIN25"]>=10),(F.round(df["iGuAuALLfrPub_COIN25"],2))).otherwise(df["riGuAuALLfrPub_COIN25"]))
    df=df.withColumn("riGuAuALLfrPub_COIN25",F.when((df["iGuAuALLfrPub_COIN25"]<10)&(df["iGuAuALLfrPub_COIN25"]>=1),(F.round(df["iGuAuALLfrPub_COIN25"],3))).otherwise(df["riGuAuALLfrPub_COIN25"]))
    df=df.withColumn("riGuAuALLfrPub_COIN25",F.when((df["iGuAuALLfrPub_COIN25"]<1),(F.round(df["iGuAuALLfrPub_COIN25"],4))).otherwise(df["riGuAuALLfrPub_COIN25"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN50",F.when(df["iGuAuALLfrRCR_COIN50"]>=1000,(F.round(df["iGuAuALLfrRCR_COIN50"],0))).otherwise(df["iGuAuALLfrRCR_COIN50"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN50",F.when((df["iGuAuALLfrRCR_COIN50"]<1000)&(df["iGuAuALLfrRCR_COIN50"]>=100),(F.round(df["iGuAuALLfrRCR_COIN50"],1))).otherwise(df["riGuAuALLfrRCR_COIN50"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN50",F.when((df["iGuAuALLfrRCR_COIN50"]<100)&(df["iGuAuALLfrRCR_COIN50"]>=10),(F.round(df["iGuAuALLfrRCR_COIN50"],2))).otherwise(df["riGuAuALLfrRCR_COIN50"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN50",F.when((df["iGuAuALLfrRCR_COIN50"]<10)&(df["iGuAuALLfrRCR_COIN50"]>=1),(F.round(df["iGuAuALLfrRCR_COIN50"],3))).otherwise(df["riGuAuALLfrRCR_COIN50"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN50",F.when((df["iGuAuALLfrRCR_COIN50"]<1),(F.round(df["iGuAuALLfrRCR_COIN50"],4))).otherwise(df["riGuAuALLfrRCR_COIN50"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN75",F.when(df["iGuAuALLfrRCR_COIN75"]>=1000,(F.round(df["iGuAuALLfrRCR_COIN75"],0))).otherwise(df["iGuAuALLfrRCR_COIN75"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN75",F.when((df["iGuAuALLfrRCR_COIN75"]<1000)&(df["iGuAuALLfrRCR_COIN75"]>=100),(F.round(df["iGuAuALLfrRCR_COIN75"],1))).otherwise(df["riGuAuALLfrRCR_COIN75"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN75",F.when((df["iGuAuALLfrRCR_COIN75"]<100)&(df["iGuAuALLfrRCR_COIN75"]>=10),(F.round(df["iGuAuALLfrRCR_COIN75"],2))).otherwise(df["riGuAuALLfrRCR_COIN75"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN75",F.when((df["iGuAuALLfrRCR_COIN75"]<10)&(df["iGuAuALLfrRCR_COIN75"]>=1),(F.round(df["iGuAuALLfrRCR_COIN75"],3))).otherwise(df["riGuAuALLfrRCR_COIN75"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN75",F.when((df["iGuAuALLfrRCR_COIN75"]<1),(F.round(df["iGuAuALLfrRCR_COIN75"],4))).otherwise(df["riGuAuALLfrRCR_COIN75"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN25",F.when(df["iGuAuALLfrRCR_COIN25"]>=1000,(F.round(df["iGuAuALLfrRCR_COIN25"],0))).otherwise(df["iGuAuALLfrRCR_COIN25"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN25",F.when((df["iGuAuALLfrRCR_COIN25"]<1000)&(df["iGuAuALLfrRCR_COIN25"]>=100),(F.round(df["iGuAuALLfrRCR_COIN25"],1))).otherwise(df["riGuAuALLfrRCR_COIN25"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN25",F.when((df["iGuAuALLfrRCR_COIN25"]<100)&(df["iGuAuALLfrRCR_COIN25"]>=10),(F.round(df["iGuAuALLfrRCR_COIN25"],2))).otherwise(df["riGuAuALLfrRCR_COIN25"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN25",F.when((df["iGuAuALLfrRCR_COIN25"]<10)&(df["iGuAuALLfrRCR_COIN25"]>=1),(F.round(df["iGuAuALLfrRCR_COIN25"],3))).otherwise(df["riGuAuALLfrRCR_COIN25"]))
    df=df.withColumn("riGuAuALLfrRCR_COIN25",F.when((df["iGuAuALLfrRCR_COIN25"]<1),(F.round(df["iGuAuALLfrRCR_COIN25"],4))).otherwise(df["riGuAuALLfrRCR_COIN25"])) 
    df=df.select("G1_","N_COUNT","TC","riRawPub_COIN50","riRawPub_COIN75","riRawPub_COIN25","riRawRCR_COIN50","riRawRCR_COIN75","riRawRCR_COIN25","riAuALLfrPub_COIN50","riAuALLfrPub_COIN75","riAuALLfrPub_COIN25","riAuALLfrRCR_COIN50","riAuALLfrRCR_COIN75","riAuALLfrRCR_COIN25","riGuRawPub_COIN50","riGuRawPub_COIN75","riGuRawPub_COIN25","riGuRawRCR_COIN50","riGuRawRCR_COIN75","riGuRawRCR_COIN25","riGuAuALLfrPub_COIN50","riGuAuALLfrPub_COIN75","riGuAuALLfrPub_COIN25","riGuAuALLfrRCR_COIN50","riGuAuALLfrRCR_COIN75","riGuAuALLfrRCR_COIN25") 
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.2ad04af9-845d-413c-aeed-dd07b94b796f"),
    RawInvFundingByGrantAndYear=Input(rid="ri.foundry.main.dataset.0e60d80b-83f1-4eda-ad82-2e51aaca0ba4")
)
from pyspark.sql import functions as F
def PRE_RJD5(RawInvFundingByGrantAndYear):
    df=RawInvFundingByGrantAndYear
    df=df.groupBy("G1","FY","Support_YR","Proj_Num","Grant_Num","Full_Gr_Num").agg(F.collect_list("Appl_Type").alias("Appl_Type_LIST"),F.collect_list("Sub_Proj_ID").alias("Sub_Proj_ID_LIST"),F.collect_list("Proj_PIID").alias("Proj_PIID_LIST"),F.collect_list("Proj_PI_Full_Name").alias("Proj_PI_Full_Name_LIST"),F.collect_list("Proj_PI_Org").alias("Proj_PI_Org_LIST"),F.collect_list("Title").alias("Title_LIST"),F.sum(df["Count"]).alias("SUM_Count"),F.sum(df["TC"]).alias("SUM_PJorCORE_TC"))
    df=df.withColumn("Appl_Type_LIST",F.concat_ws(",",F.col("Appl_Type_LIST")))
    df=df.withColumn("Sub_Proj_ID_LIST",F.concat_ws(",",F.col("Sub_Proj_ID_LIST")))
    df=df.withColumn("Proj_PIID_LIST",F.concat_ws(",",F.col("Proj_PIID_LIST")))
    df=df.withColumn("Proj_PI_Full_Name_LIST",F.concat_ws(",",F.col("Proj_PI_Full_Name_LIST")))
    df=df.withColumn("Proj_PI_Org_LIST",F.concat_ws(",",F.col("Proj_PI_Org_LIST")))
    df=df.withColumn("Title_LIST",F.concat_ws(",",F.col("Title_LIST")))
    df1=df.filter(df["Proj_Num"]!="C")
    df2=df.filter(df["Proj_Num"]=="C")
    df1=df1.withColumn("PJ_TC",df1["SUM_PJorCORE_TC"]/df1["SUM_Count"])
    df3=df1.withColumn("PJperGr_Count",F.lit(1))
    df3=df3.groupBy("G1","FY","Full_Gr_Num").agg(F.collect_list("Proj_Num").alias("PJ_Num_LIST"),F.sum(df3["PJperGr_Count"]).alias("SUM_PJperGr_Count"))
    df3=df3.withColumnRenamed("G1","G1_")
    df3=df3.withColumnRenamed("FY","FY_")
    df3=df3.withColumnRenamed("Full_Gr_Num","Full_Gr_Num_")
    df2=df2.select("G1","FY","Proj_Num","Full_Gr_Num","SUM_PJorCORE_TC")
    df2=df2.join(df3,(df2["G1"]==df3["G1_"])&(df2["FY"]==df3["FY_"])&(df2["Full_Gr_Num"]==df3["Full_Gr_Num_"]),'inner')
    df2=df2.withColumn("TC_COREperPJ",df2["SUM_PJorCORE_TC"]/df2["SUM_PJperGr_Count"])
    df2=df2.select("G1","FY","Proj_Num","Full_Gr_Num","TC_COREperPJ")
    df2=df2.withColumnRenamed("G1","G1_")
    df2=df2.withColumnRenamed("FY","FY_")
    df2=df2.withColumnRenamed("Proj_Num","Proj_Num_")
    df2=df2.withColumnRenamed("Full_Gr_Num","Full_Gr_Num_")
    df1=df1.select("G1","FY","Proj_Num","Grant_Num","Full_Gr_Num","Proj_PIID_LIST","SUM_Count","PJ_TC")
    df1=df1.join(df2,(df1["G1"]==df2["G1_"])&(df1["FY"]==df2["FY_"])&(df1["Full_Gr_Num"]==df2["Full_Gr_Num_"]),'left')
    df1=df1.withColumn("TC_COREperPJ",F.when(F.isnull("TC_COREperPJ"),0).otherwise(F.col("TC_COREperPJ")))
    df1=df1.withColumn("PplusC_TC",F.col("PJ_TC")+F.col("TC_COREperPJ"))
    df1=df1.withColumn("PJ+CORE/Investigator_TC",df1["PplusC_TC"]/df1["SUM_Count"])
    df1=df1.select("G1","FY","Proj_Num","Grant_Num","Full_Gr_Num","Proj_PIID_LIST","PJ+CORE/Investigator_TC")
    df1=df1.withColumn("Proj_PIID_LIST",F.split(df["Proj_PIID_LIST"],","))
    df1=df1.select("G1","FY","Proj_Num","Grant_Num","Full_Gr_Num","PJ+CORE/Investigator_TC",F.explode("Proj_PIID_LIST").alias("Proj_PIID")) 
    df4=RawInvFundingByGrantAndYear.select("Proj_PIID","Proj_PI_Full_Name")
    df4=df4.dropDuplicates(["Proj_PIID"])
    df4=df4.withColumnRenamed("Proj_PIID","Proj_PIID_")
    df1=df1.join(df4,(df1["Proj_PIID"]==df4["Proj_PIID_"]),'left')
    df1=df1.select("G1","FY","Proj_Num","Grant_Num","Full_Gr_Num","PJ+CORE/Investigator_TC","Proj_PIID","Proj_PI_Full_Name")
    df1=df1.withColumn("Proj_PI_Last_Name",F.upper(F.col("Proj_PI_Full_Name")))
    df1=df1.withColumn('Proj_PI_Last_Name',F.regexp_replace('Proj_PI_Last_Name',r'(^[^,]*?)([,].*)$','$1'))
    df1=df1.withColumn('Proj_PI_Last_Name',F.regexp_replace('Proj_PI_Last_Name',r'[^a-zA-Z]',''))
    df1=df1.select("G1","FY","Grant_Num","Proj_PIID","Proj_PI_Last_Name","PJ+CORE/Investigator_TC")
    df1=df1.groupBy("G1","FY","Grant_Num","Proj_PIID","Proj_PI_Last_Name").agg(F.sum(df1["PJ+CORE/Investigator_TC"]).alias("Invr_TC_FR"))
    return df1

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.d5e7e10f-76d5-4bee-b576-163ff0dd6d5d"),
    iCite_WOS=Input(rid="ri.foundry.main.dataset.f7de7c8a-fffa-479c-92fd-7accfe2e9113")
)
from pyspark.sql import functions as F
def RJD1(iCite_WOS):
    df=iCite_WOS
    df=df.withColumn("DT",F.when(F.isnull("DT"),0).otherwise(F.col("DT")))
    df=df.withColumn("FU",F.when(F.isnull("FU"),0).otherwise(F.col("FU")))
    df=df.withColumn("RCR",F.when(F.isnull("RCR"),0).otherwise(F.col("RCR")))
    df=df.withColumn("DHHS_Grant",F.split(df["DHHS_Grant"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","DHHS_Grant",F.explode("DHHS_Grant").alias("DHHS_GrantE"))
    df=df.withColumn("DHHS_GrantT",F.substring(df["DHHS_GrantE"],-8,8))
    df=df.dropDuplicates(["PMID","DHHS_GrantT"])
    df=df.groupBy("PMID","PubYr","RCR","DT","FU","DHHS_Grant").agg(F.collect_list("DHHS_GrantT").alias("DHHS_GrantT"),F.count("DHHS_GrantT").alias("DHHS_GrantN"))
    df=df.withColumn('FU',F.regexp_replace(F.col('FU'),'@',''))
    df=df.withColumn('FU1',F.regexp_replace(F.col('FU'),',','@'))
    df=df.withColumn("FU1",F.split(df["FU1"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FU1",F.explode("FU1").alias("FU2"))
    df=df.withColumn('FU2',F.regexp_replace(F.regexp_replace('FU2','<',''),'>',''))
    df=df.withColumn('FU2',F.regexp_replace(F.regexp_replace('FU2','\\[','<'),'\\]','>'))
    df=df.withColumn('FU2',F.regexp_replace('FU2',r'([^<>]*?)(<.*?>)','$2'))
    df=df.withColumn('FU3',F.regexp_replace('FU2','<.*?>',''))
    df=df.withColumn('FU4',F.regexp_replace('FU2',r'^[^<].*',''))
    df=df.withColumn('FU3',F.regexp_replace('FU3','@',''))
    df=df.withColumn('FU5',F.concat(F.col('FU3'),F.col('FU4')))
    df=df.withColumn('FU5',F.regexp_replace(F.regexp_replace(F.regexp_replace('FU5','<',''),'>',''),'@',','))
    df=df.groupBy('PMID','PubYr','RCR','DT','FU','DHHS_Grant','DHHS_GrantT','DHHS_GrantN').agg(F.collect_list('FU5').alias('FU5'))
    df=df.withColumn("FU5",F.concat_ws(";",F.col("FU5")))
    df=df.withColumn('FU5',F.regexp_replace('FU5',',',';'))
    df=df.withColumn("DHHS_Grant",F.concat_ws(";",F.col("DHHS_Grant")))
    df=df.withColumn("DHHS_GrantT",F.concat_ws(";",F.col("DHHS_GrantT")))
    df=df.withColumn('FUT',F.translate('FU5','[({})]','<<<>>>'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'\'',''))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'\"',''))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(The |\bthe )',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'Inc[//.]',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'LLC[//.]',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'Ltd[//.]',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'Co[//.]',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'GmbH',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'([a-z][,;//.]?[ ]?)(AG|UK|AB)([ ]?[A-Z][a-z]|[//.][ ]|>[ ]|<[ ]|[,;])','$1$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(United States|USA)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(US|U[//.]S[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(U[//.]S[//.]?|National Science Foundation|NSF|N[//.]S[//.]F[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Department of Defense|DOD|D[//.]O[//.]D[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Department of Energy|DOE|D[//.]O[//.]E[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? of Occupational Safety and Health|National Institute of Occupational Safety & Health|NIOSH|N[//.]I[//.]O[//.]S[//.]H[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Department of Agriculture|USDA|U[//.]S[//.]D[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Veterans Affairs|VA|V[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Food and Drug Administration|FDA|F[//.]D[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Agency for Healthcare Research and Quality|AHRQ|A[//.]H[//.]R[//.]Q[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Department of Health & Human Services|Department of Health and Human Services|D?HHS|D[//.]H[//.]H[//.]S[//.]?|H[//.]H[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Library of Medicine|NLM|N[//.]L[//.]M[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? o[nf] Health|NIH|N[//.]I[//.]H[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? of Mental Health|NIMH|N[//.]I[//.]M[//.]H[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Public Health Service|PHS|P[//.]H[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Cancer Institutes?|NCI|N[//.]C[//.]I[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Eye Institutes?|NEI|N[//.]E[//.]I[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Heart,? Lung,? and Blood Institutes?|National Heart,? Lung,? & Blood Institutes?|NHLBI|N[//.]H[//.]L[//.]B[//.]I[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Human Genome Research Institutes?|NHGRI|N[//.]H[//.]G[//.]R[//.]I[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? o[nf] Alcohol Abuse and Alcoholism|National Institutes? o[nf] Alcohol Abuse & Alcoholism|NIAAA|N[//.]I[//.]A[//.]A[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? o[nf] Allergy and Infectious Diseases|National Institutes? o[nf] Allergy & Infectious Diseases|NIAID|N[//.]I[//.]A[//.]I[//.]D[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? o[nf] Arthritis and Musculoskeletal and Skin Diseases|National Institutes? o[nf] Arthritis & Musculoskeletal and Skin Diseases)',' '),r'(National Institutes? o[nf] Arthritis and Musculoskeletal & Skin Diseases)',' '),r'(National Institutes? of Arthritis & Musculoskeletal & Skin Diseases|NIAMS|N[//.]I[//.]A[//.]M[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? o[nf] Aging|NIA|N[//.]I[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? o[nf] Biomedical Imaging and Bioengineering|National Institutes? o[nf] Biomedical Imaging & Bioengineering)',' '),r'(National Institutes? for Biomedical Imaging and Bioengineering|National Institutes? for Biomedical Imaging & Bioengineering)',' '),r'(NIBIB|N[//.]I[//.]B[//.]I[//.]B[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? o[nf] Child Health and Human Development|National Institutes? o[nf] Child Health & Human Development)',' '),r'(National Institutes? for Child Health and Human Development|National Institutes? for Child Health & Human Development)',' '),r'(Eunice Kennedy Shriver|NICHD|N[//.]I[//.]C[//.]H[//.]D[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? o[nf] General Medical Sciences?|NIGMS|N[//.]I[//.]G[//.]M[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? o[nf] Deafness and Other Communication Disorders|National Institutes? o[nf] Deafness & Other Communication Disorders)',' '),r'(National Institutes? for Deafness and Other Communication Disorders|National Institutes? for Deafness & Other Communication Disorders)',' '),r'(NIDCD|N[//.]I[//.]D[//.]C[//.]D[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? o[nf] Diabetes and Digestive and Kidney Diseases|National Institutes? o[nf] Diabetes & Digestive and Kidney Diseases)',' '),r'(National Institutes? o[nf] Diabetes and Digestive & Kidney Diseases|National Institutes? o[nf] Diabetes & Digestive & Kidney Diseases)',' '),r'(NIDDK|N[//.]I[//.]D[//.]D[//.]K[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? o[nf] Drug Abuse|NIDA|N[//.]I[//.]D[//.]A[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? of Environmental Health Sciences|NIEHS|N[//.]I[//.]E[//.]H[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? o[nf] Minority Health and Health Disparities|National Institutes? o[nf] Minority Health & Health Disparities)',' '),r'(National Institutes? for Minority Health and Health Disparities|National Institutes? for Minority Health & Health Disparities)',' '),r'(NIMHD|N[//.]I[//.]M[//.]H[//.]D[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace(F.regexp_replace(F.regexp_replace('FUT',r'(National Institutes? of Neurological Disorders and Stroke|National Institutes? of Neurological Disorders & Stroke)',' '),r'(National Institutes? of Neurological Diseases? and Stroke|National Institutes? of Neurological Diseases? & Stroke)',' '),r'(NINDS|N[//.]I[//.]N[//.]D[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Institutes? of Nursing Research|NINR|N[//.]I[//.]N[//.]R[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Center for Advancing Translational Sciences|NCATS|N[//.]C[//.]A[//.]T[//.]S[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Center for Complementary and Integrative Health|National Center for Complementary & Integrative Health|NCCIH|N[//.]C[//.]C[//.]I[//.]H[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Center for Complementary and Alternative Medicine|National Center for Complementary & Alternative Medicine|NCCAM|N[//.]C[//.]C[//.]A[//.]M[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Center for Research Resources|NCRR|N[//.]C[//.]R[//.]R[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(National Center for Complementary and Alternative Medicine|National Center for Complementary & Alternative Medicine|NCCAM|N[//.]C[//.]C[//.]A[//.]M[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Fogarty International Center|FIC|F[//.]I[//.]C[//.]?)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Agency|Department|Fellowship|Research|Grant|Award|Pharmaceuticals|Institute|Foundation|Program|Programme|Alliance|Center|Centre|Society|Fund|Trust|Group|Cancer|Company|Corporation|Laborator|Holding|Inc\b|GmbH|Union)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(Pancreatic|Ovarian|Breast|Prostate|Lung|Kidney)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(American|Australia|Austria|Belgium|Bra[zs]il|British|Canada|China|Denmark|Deutschland|Deutsche|European|France|Finland|Germany|Italy|Italian|Ireland|Japan|Norway|New Zeeland|Portugal|Poland|Russia|Spain|Sweden|Swedish|Switzerland|U[//.]K[//.]|United Kingdom)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(#|%|@|&)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'([a-z])([A-Z0-9])','$1 $2'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(^|[,]|[;]|[ ])([A-Z0-9/-]+)([ ])([A-Z0-9/-]+)([,]|[;]|[ ]|$)','$1$2$4$5'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(^|[,]|[;]|[ ])([A-Z0-9/-]+)([ ])([A-Z0-9/-]+)([,]|[;]|[ ]|$)','$1$2$4$5'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(^|;| )([^0-9A-Z; ]+)(;| |$)','$1$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(^|;| )([^0-9A-Z; ]+)(;| |$)','$1$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(^|;| )([A-Z][//.]?)(;| |$)','$1$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(^|;| )([A-Z][//.]?)(;| |$)','$1$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'([A-Z0-9/-//.])([<])([A-Z0-9/-//.])','$1@@@$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'([A-Z0-9-//.])([>])([A-Z0-9]|[/-//.][A-Z0-9])','$1@@@$3'))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'@@@',''))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'(<|>)',' '))
    df=df.withColumn('FUT',F.regexp_replace('FUT',r'([;])([ ]+)([;])','$1'))
    df=df.withColumn("DHHS_GrantT",F.split(df["DHHS_GrantT"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","FUT","FU5","DHHS_Grant","DHHS_GrantT","DHHS_GrantN",F.explode("DHHS_GrantT").alias("DHHS_GrantT1"))
    df=df.withColumn("DHHS_GrantT2",F.substring(df["DHHS_GrantT1"],-4,4))
    df=df.withColumn("DHHS_GrantT3",df["DHHS_GrantT2"])
    df=df.withColumn('DHHS_GrantT2',F.regexp_replace('DHHS_GrantT2',r'^([0-9])([0-9])([0-9])([0-9])','$1$2$3;$2$3$4'))
    df=df.withColumn("DHHS_GrantT2",F.when(F.col("DHHS_GrantN")>"9",F.col("DHHS_GrantT3")).otherwise(F.col("DHHS_GrantT2")))
    df=df.withColumn("DHHS_GrantT2",F.split(df["DHHS_GrantT2"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","FUT","FU5","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","DHHS_GrantT1",F.explode("DHHS_GrantT2").alias("DHHS_GrantT3"))
    df=df.withColumn("FUT",F.split(df["FUT"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FUT","DHHS_GrantT1","DHHS_GrantT3",F.explode("FUT").alias("FUTEX1"))
    df=df.withColumn("FUTEX1",F.trim(F.col("FUTEX1")))
    df=df.withColumn('FUTEX1',F.regexp_replace('FUTEX1',r'^([A-Z])([A-Z])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])$','%$1%$2%$3%$4%$5%$6%$7%$8%'))
    df=df.withColumn("FUTEX2",df["FUTEX1"])
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9]{6})([0-9]{2}[SA][0-9]{1,2})$','$1$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9]{6})([0-9]{2})$','$1$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9OSI]{3,6})([-][0-9]{1,2}[S][0-9]{1,2})$','$1$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9OSI]{3,6})([-][0-9]{1,2}[A][0]?[12])$','$1$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9OSI]{3,6})([-][S][0-9]{1,2})$','$1$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9OSI]{3,6})([-][A][0]?[12])$','$1$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'(^.*?)([0-9OSI]{3,6})([-][0-9]{1,2})$','$1$2'))
    df=df.withColumn('FUTEX2',F.translate('FUTEX2','/ -&',''))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'^([A-Z0-9]{0,5}[A-Z])([0-9]{3,8})$','$1&$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'^([A-Z0-9]{0,5}[A-Z])([0-9IOS]{5,8})$','$1&$2'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'^([0-9IOS]{3,8})$','&$1'))
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'^[^&]*$',''))
    df=df.withColumn("FUTEX3",df["FUTEX2"])
    df=df.withColumn('FUTEX2',F.regexp_replace('FUTEX2',r'^([^&]*?)(&)([^&]*?)$','$1'))
    df=df.withColumn('FUTEX3',F.regexp_replace('FUTEX3',r'^([^&]*?)(&)([^&]*?)$','$3'))
    df=df.withColumn('FUTEX3',F.translate('FUTEX3','ISO','150'))
    df=df.withColumn("FUTEX4",F.concat(F.col("FUTEX2"),F.lit(""),F.col("FUTEX3")))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^([0-9]{3,7})$','$1&'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^(A[ADE-IMOR-T015]|B[A-UX015]|C[A-EHIK-PTUX01]|D[ACDEHKPS5]|E[BHPSY5]|F[DP]|G[DFHMW]|H[BCDGHIKLMORVXY01]|[I1][PH]|L[MS5]|M[BDHNP]|N[BDHRSU5]|[O0][ACDEFHLPRTW]|P[CEGHRS5]|R[ACDGIMRSX15]|[S5][ACEFHMOPTU0]|T[IPRSW5]|VA|W[CHT])([0-9]{3,7})$','$1$2&'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^(C[O0]6|D43|D7[1I]|DP[1-57IS]|E[1I][1I]|F[O0][5S]|F3[0-378IO]|F99|F[1I]2|G[0O][78]|G[1I][1-3I]|G2[0O]|G94|H[1I]3|H2[258S]|H[5S][07O]|H6[24]|H7[59S]|HD4|[I1][0O][1I]|[I1]8[0O]|[I1]K3|K[0O][0-25-8OIS]|K[1I][248]|K2[1-6IS]|K3[08O]|K43|K76|K99|KD[1I]|KL[12I]|KM[1I]|L3[02O]|L[456S][0O]|M[0O][1I]|N[0O][1-4I]|[O0]T2|P[L-O04][1I]|P[2-6S][0O]|P2C|P[4N]2|R[0O][0-3OI]|R[1I][2568S]|R2[1458ISF]|R3[03-8OS]|R4[1-49I]|R[5S][056OS]|R6[1I]|R9[0O]|RC[1-4I]|R[FLMS5][1I]|RL[259S]|[S5][0O][67]|[S5][1I][01OI]|[S5]2[12I]|[S5][BC][1I]|[S5]C[23]|[S5][1I]2|T[0O][12459IS]|T[1I][45S]|T3[2457S]|T42|T9[0O]|TL[14I]|U[0O][19I]|U[1I][0-37-9IABQV]|U2[1-47CFGIR]|U3[02468O]|U4[1-578IS]|U[5S][0-9IOS]|U6[0-256IOS]|U7[59S]|U8[1234I]|U9[90O]|UA[5S]|U[A-HLMT][1I]|UC[2-467]|UE[25S]|U[FHMT]2|U[GH][34]|UP[5S]|UR[68]|U[S5][34]|VF[1I]|X[0O][12I]|X9[89]|Y[12I]|Z[I1][ACE]|Z[0O][1I])(A[ADE-IMOR-T015]|B[A-UX015]|C[A-EHIK-PTUX01]|D[ACDEHKPS5]|E[BHPSY5]|F[DP]|G[DFHMW]|H[BCDGHIKLMORVXY01]|[I1][PH]|L[MS5]|M[BDHNP]|N[BDHRSU5]|[O0][ACDEFHLPRTW]|P[CEGHRS5]|R[ACDGIMRSX15]|[S5][ACEFHMOPTU0]|T[IPRSW5]|VA|W[CHT])([0-9]{3,7})$','$2$3&'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^([1235])(C[O0]6|D43|D7[1I]|DP[1-57IS]|E[1I][1I]|F[O0][5S]|F3[0-378IO]|F99|F[1I]2|G[0O][78]|G[1I][1-3I]|G2[0O]|G94|H[1I]3|H2[258S]|H[5S][07O]|H6[24]|H7[59S]|HD4|[I1][0O][1I]|[I1]8[0O]|[I1]K3|K[0O][0-25-8OIS]|K[1I][248]|K2[1-6IS]|K3[08O]|K43|K76|K99|KD[1I]|KL[12I]|KM[1I]|L3[02O]|L[456S][0O]|M[0O][1I]|N[0O][1-4I]|[O0]T2|P[L-O04][1I]|P[2-6S][0O]|P2C|P[4N]2|R[0O][0-3OI]|R[1I][2568S]|R2[1458ISF]|R3[03-8OS]|R4[1-49I]|R[5S][056OS]|R6[1I]|R9[0O]|RC[1-4I]|R[FLMS5][1I]|RL[259S]|[S5][0O][67]|[S5][1I][01OI]|[S5]2[12I]|[S5][BC][1I]|[S5]C[23]|[S5][1I]2|T[0O][12459IS]|T[1I][45S]|T3[2457S]|T42|T9[0O]|TL[14I]|U[0O][19I]|U[1I][0-37-9IABQV]|U2[1-47CFGIR]|U3[02468O]|U4[1-578IS]|U[5S][0-9IOS]|U6[0-256IOS]|U7[59S]|U8[1234I]|U9[90O]|UA[5S]|U[A-HLMT][1I]|UC[2-467]|UE[25S]|U[FHMT]2|U[GH][34]|UP[5S]|UR[68]|U[S5][34]|VF[1I]|X[0O][12I]|X9[89]|Y[12I]|Z[I1][ACE]|Z[0O][1I])(A[ADE-IMOR-T015]|B[A-UX015]|C[A-EHIK-PTUX01]|D[ACDEHKPS5]|E[BHPSY5]|F[DP]|G[DFHMW]|H[BCDGHIKLMORVXY01]|[I1][PH]|L[MS5]|M[BDHNP]|N[BDHRSU5]|[O0][ACDEFHLPRTW]|P[CEGHRS5]|R[ACDGIMRSX15]|[S5][ACEFHMOPTU0]|T[IPRSW5]|VA|W[CHT])([0-9]{3,7})$','$3$4&'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^(C[O0]6|D43|D7[1I]|DP[1-57IS]|E[1I][1I]|F[O0][5S]|F3[0-378IO]|F99|F[1I]2|G[0O][78]|G[1I][1-3I]|G2[0O]|G94|H[1I]3|H2[258S]|H[5S][07O]|H6[24]|H7[59S]|HD4|[I1][0O][1I]|[I1]8[0O]|[I1]K3|K[0O][0-25-8OIS]|K[1I][248]|K2[1-6IS]|K3[08O]|K43|K76|K99|KD[1I]|KL[12I]|KM[1I]|L3[02O]|L[456S][0O]|M[0O][1I]|N[0O][1-4I]|[O0]T2|P[L-O04][1I]|P[2-6S][0O]|P2C|P[4N]2|R[0O][0-3OI]|R[1I][2568S]|R2[1458ISF]|R3[03-8OS]|R4[1-49I]|R[5S][056OS]|R6[1I]|R9[0O]|RC[1-4I]|R[FLMS5][1I]|RL[259S]|[S5][0O][67]|[S5][1I][01OI]|[S5]2[12I]|[S5][BC][1I]|[S5]C[23]|[S5][1I]2|T[0O][12459IS]|T[1I][45S]|T3[2457S]|T42|T9[0O]|TL[14I]|U[0O][19I]|U[1I][0-37-9IABQV]|U2[1-47CFGIR]|U3[02468O]|U4[1-578IS]|U[5S][0-9IOS]|U6[0-256IOS]|U7[59S]|U8[1234I]|U9[90O]|UA[5S]|U[A-HLMT][1I]|UC[2-467]|UE[25S]|U[FHMT]2|U[GH][34]|UP[5S]|UR[68]|U[S5][34]|VF[1I]|X[0O][12I]|X9[89]|Y[12I]|Z[I1][ACE]|Z[0O][1I])([0-9]{3,7})$','$1$2&'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^([1235])(C[O0]6|D43|D7[1I]|DP[1-57IS]|E[1I][1I]|F[O0][5S]|F3[0-378IO]|F99|F[1I]2|G[0O][78]|G[1I][1-3I]|G2[0O]|G94|H[1I]3|H2[258S]|H[5S][07O]|H6[24]|H7[59S]|HD4|[I1][0O][1I]|[I1]8[0O]|[I1]K3|K[0O][0-25-8OIS]|K[1I][248]|K2[1-6IS]|K3[08O]|K43|K76|K99|KD[1I]|KL[12I]|KM[1I]|L3[02O]|L[456S][0O]|M[0O][1I]|N[0O][1-4I]|[O0]T2|P[L-O04][1I]|P[2-6S][0O]|P2C|P[4N]2|R[0O][0-3OI]|R[1I][2568S]|R2[1458ISF]|R3[03-8OS]|R4[1-49I]|R[5S][056OS]|R6[1I]|R9[0O]|RC[1-4I]|R[FLMS5][1I]|RL[259S]|[S5][0O][67]|[S5][1I][01OI]|[S5]2[12I]|[S5][BC][1I]|[S5]C[23]|[S5][1I]2|T[0O][12459IS]|T[1I][45S]|T3[2457S]|T42|T9[0O]|TL[14I]|U[0O][19I]|U[1I][0-37-9IABQV]|U2[1-47CFGIR]|U3[02468O]|U4[1-578IS]|U[5S][0-9IOS]|U6[0-256IOS]|U7[59S]|U8[1234I]|U9[90O]|UA[5S]|U[A-HLMT][1I]|UC[2-467]|UE[25S]|U[FHMT]2|U[GH][34]|UP[5S]|UR[68]|U[S5][34]|VF[1I]|X[0O][12I]|X9[89]|Y[12I]|Z[I1][ACE]|Z[0O][1I])([0-9]{3,7})$','$2$3&'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^[^&]*$',''))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'(^[0-9]*)([&])$','$1'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'(^.*[A-Z])([0-9]*)([&])$','$2'))
    df=df.withColumn("FUTEX5",df["FUTEX4"])
    df=df.withColumn("FUTEX4",F.substring(df["FUTEX4"],-4,4))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^([0-9])([0-9])([0-9])$','0$1$2$3'))
    df=df.withColumn('FUTEX4',F.regexp_replace('FUTEX4',r'^([0-9])([0-9])$','00$1$2'))
    df=df.withColumn("FUTEX5",F.substring(df["FUTEX5"],-5,5))
    df=df.withColumn('FUTEX5',F.regexp_replace('FUTEX5',r'^([0])([0])([0-9])([0-9])([0-9])$','$2$3$4$5'))
    df=df.withColumn('FUTEX5',F.regexp_replace('FUTEX5',r'^([0])([0])([0-9])([0-9])$','$2$3$4'))
    df=df.withColumn('FUTEX5',F.regexp_replace('FUTEX5',r'^([0-9])([0-9])$','0$1$2'))
    df=df.withColumn('FUTEX5',F.regexp_replace('FUTEX5',r'^([0-9])([0-9])([0-9])([0-9])$','$1$2$3;$2$3$4'))
    df=df.withColumn('FUTEX5',F.regexp_replace('FUTEX5',r'^([0-9])([0-9])([0-9])([0-9])([0-9])$','$1$2$3;$2$3$4;$3$4$5'))
    df=df.withColumn("FUTEX5",F.when(F.col("DHHS_GrantN")>"9",F.col("FUTEX4")).otherwise(F.col("FUTEX5")))
    df=df.withColumn("FUTEX5",F.split(df["FUTEX5"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FUT","DHHS_GrantT1","DHHS_GrantT3","FUTEX1",F.explode("FUTEX5").alias("FUTEX6"))
    df=df.withColumn("FUT",F.concat_ws(";",F.col("FUT")))
    df=df.withColumn("Match2",F.when((F.col("FUTEX1")==""),2).when(F.col("FUTEX6")==F.col("DHHS_GrantT3"),1).otherwise(0))
    df=df.withColumn('Match2',F.translate('Match2','02',''))
    df=df.withColumn("Match3",df["Match2"])
    df=df.withColumn('Match3',F.regexp_replace('Match3',r'[1]','%%%'))
    df=df.withColumn("DHHST1tag",F.concat(F.col("DHHS_GrantT1"),F.lit(""),F.col("Match3")))
    df=df.groupBy("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FUT","FUTEX1").agg(F.collect_list("DHHST1tag").alias("DHHST1tag"),F.collect_list("Match2").alias("Match2"))
    df=df.withColumn("Match2",F.concat_ws("",F.col("Match2")))
    df=df.withColumn("DHHST1tag",F.concat_ws(";",F.col("DHHST1tag")))
    df=df.withColumn('Match2',F.regexp_replace('Match2',r'[1]{1,10}','1'))
    df=df.withColumn('DHHST1tag',F.regexp_replace('DHHST1tag',r'^[^%]*$',''))
    df=df.withColumn('DHHST1tag',F.regexp_replace('DHHST1tag',r'(%%%)(.*)$','$1'))
    df=df.withColumn('DHHST1tag',F.regexp_replace('DHHST1tag',r'(^[^%]*)(;)([^;%]*?)(%%%)','$3'))
    df=df.withColumn("FUTEX1",F.when(F.col("Match2")=="1",F.col("DHHST1tag")).otherwise(F.col("FUTEX1")))
    df=df.withColumn('FUTEX1',F.regexp_replace('FUTEX1',r'^(%)([A-Z])(%)([A-Z])(%)([0-9])(%)([0-9])(%)([0-9])(%)([0-9])(%)([0-9])(%)([0-9])(%)$','$2$4$6$8$10$12$14$16'))
    df=df.groupBy("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FUT").agg(F.collect_list("FUTEX1").alias("FUTEX1"))
    df=df.withColumn("FUTEX1",F.concat_ws(";",F.col("FUTEX1")))
    df=df.withColumn("DHHS_GrantT",F.concat_ws(";",F.col("DHHS_GrantT")))
    df=df.withColumn("ALLGr",F.concat(F.col("DHHS_GrantT"),F.lit(";"),F.col("FUTEX1")))
    df=df.withColumn("ALLGr",F.split(df["ALLGr"],";"))
    df=df.select("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FUT",F.explode("ALLGr").alias("ALLGrant"))
    df=df.dropDuplicates(["PMID","ALLGrant"])
    df=df.filter(df["ALLGrant"]!="0")
    df=df.groupBy("PMID","PubYr","RCR","DT","FU","DHHS_Grant","DHHS_GrantT","DHHS_GrantN","FUT").agg(F.collect_list("ALLGrant").alias("ALLGrant"),F.count("ALLGrant").alias("ALLGrantN"))
    df=df.withColumn("ALLGrant",F.concat_ws(";",F.col("ALLGrant")))
    df=df.withColumn("Pub",F.lit(1))
    df=df.withColumn("PubPerHHSGr_FRAC",(F.col("Pub")/F.col("DHHS_GrantN")))
    df=df.withColumn("PubPerALLGr_FRAC",F.when(F.col("ALLGrantN")=="0",0).otherwise(F.col("Pub")/F.col("ALLGrantN")))
    df=df.withColumn("RCRperHHSGr_FRAC",(F.col("RCR")/F.col("DHHS_GrantN")))
    df=df.withColumn("RCRperALLGr_FRAC",F.when(F.col("ALLGrantN")=="0",0).otherwise(F.col("RCR")/F.col("ALLGrantN")))
    df=df.dropDuplicates(["PMID"])
    df=df.select("PMID","PubYr","DHHS_GrantN","ALLGrantN","Pub","RCR","PubPerHHSGr_FRAC","PubPerALLGr_FRAC","RCRperHHSGr_FRAC","RCRperALLGr_FRAC")
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.867b7cba-c251-48c3-b809-0d80ca706012"),
    Guidelines2022=Input(rid="ri.foundry.main.dataset.8283d069-0ee7-42ac-8508-d1e3ecbf3a6e"),
    RJD1=Input(rid="ri.foundry.main.dataset.d5e7e10f-76d5-4bee-b576-163ff0dd6d5d")
)
from pyspark.sql import functions as F
def RJD2(Guidelines2022, RJD1):
    df=Guidelines2022
    df=df.join(RJD1,df["Cited_PMID"]==RJD1["PMID"],'inner')
    df=df.groupBy("Cited_PMID","DHHS_GrantN","ALLGrantN").agg(F.collect_list("G_PMID_or_File").alias("G_PMID_or_File_LIST"),F.collect_list("Guidelines_YR").alias("Guidelines_YR_LIST"),F.collect_list("Guidelines_Topic").alias("Guidelines_Topic_LIST"),F.sum(df["Pub"]).alias("SUM_CitedPub"),F.sum(df["RCR"]).alias("SUM_RCRofCitedPub"))
    df=df.withColumn("G_PubPerHHSGr_FRAC",(F.col("SUM_CitedPub")/F.col("DHHS_GrantN")))
    df=df.withColumn("G_PubPerALLGr_FRAC",F.when(F.col("ALLGrantN")=="0",0).otherwise(F.col("SUM_CitedPub")/F.col("ALLGrantN")))
    df=df.withColumn("G_RCRperHHSGr_FRAC",(F.col("SUM_RCRofCitedPub")/F.col("DHHS_GrantN")))
    df=df.withColumn("G_RCRperALLGr_FRAC",F.when(F.col("ALLGrantN")=="0",0).otherwise(F.col("SUM_RCRofCitedPub")/F.col("ALLGrantN")))
    df=df.select("Cited_PMID","G_PMID_or_File_LIST","Guidelines_YR_LIST","Guidelines_Topic_LIST","SUM_CitedPub","SUM_RCRofCitedPub","G_PubPerHHSGr_FRAC","G_PubPerALLGr_FRAC","G_RCRperHHSGr_FRAC","G_RCRperALLGr_FRAC")
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.9dad2ee6-f14a-4cb9-b048-dd9b47a81896"),
    RePORTER_PRJ_FY2009=Input(rid="ri.foundry.main.dataset.20cced4b-58a0-4f83-a409-6da46cf751e5"),
    RePORTER_PRJ_FY2010=Input(rid="ri.foundry.main.dataset.1dda42a4-a0e7-4752-8c80-3e14cfccf614"),
    RePORTER_PRJ_FY2011=Input(rid="ri.foundry.main.dataset.dc346f59-0b1d-46e4-ba03-b3e8b152cb88"),
    RePORTER_PRJ_FY2012=Input(rid="ri.foundry.main.dataset.0d0692c4-ee3d-47c7-bf21-21a587c20b66"),
    RePORTER_PRJ_FY2013=Input(rid="ri.foundry.main.dataset.d79ead06-2ba1-40b0-9786-a6d7a6c2a65a"),
    RePORTER_PRJ_FY2014=Input(rid="ri.foundry.main.dataset.f4b6095b-0017-4cd6-8331-53ad0526ce57"),
    RePORTER_PRJ_FY2015=Input(rid="ri.foundry.main.dataset.00aa9054-e3c5-4cfc-b86a-8ae2ad91d6c0"),
    RePORTER_PRJ_FY2016=Input(rid="ri.foundry.main.dataset.67bf78cc-cd30-4cf4-89a0-58f6007f0c4e"),
    RePORTER_PRJ_FY2017=Input(rid="ri.foundry.main.dataset.d927f9ec-0446-4847-96d4-fdfb2195b012"),
    RePORTER_PRJ_FY2018=Input(rid="ri.foundry.main.dataset.6096a513-721f-49c5-a5cb-bedefbebc0b8"),
    RePORTER_PRJ_FY2019=Input(rid="ri.foundry.main.dataset.d9821b47-70c5-4670-aea5-0f3e03b330c2")
)
from pyspark.sql import functions as F
def RJD3(RePORTER_PRJ_FY2009, RePORTER_PRJ_FY2010, RePORTER_PRJ_FY2011, RePORTER_PRJ_FY2012, RePORTER_PRJ_FY2013, RePORTER_PRJ_FY2014, RePORTER_PRJ_FY2015, RePORTER_PRJ_FY2016, RePORTER_PRJ_FY2017, RePORTER_PRJ_FY2018, RePORTER_PRJ_FY2019):
    df=RePORTER_PRJ_FY2009
    df=df.union(RePORTER_PRJ_FY2010)
    df=df.union(RePORTER_PRJ_FY2011)
    df=df.union(RePORTER_PRJ_FY2012)
    df=df.union(RePORTER_PRJ_FY2013)
    df=df.union(RePORTER_PRJ_FY2014)
    df=df.union(RePORTER_PRJ_FY2015)
    df=df.union(RePORTER_PRJ_FY2016)
    df=df.union(RePORTER_PRJ_FY2017)
    df=df.union(RePORTER_PRJ_FY2018)
    df=df.union(RePORTER_PRJ_FY2019)
    df=df.withColumn("CORE_PROJECT_NUM",F.substring(df["CORE_PROJECT_NUM"],-8,8))
    df=df.distinct()
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.9f035207-fdfd-46a0-adab-1eab66f57696"),
    RJD1=Input(rid="ri.foundry.main.dataset.d5e7e10f-76d5-4bee-b576-163ff0dd6d5d"),
    RePORTER_PUBLNK_C_2009=Input(rid="ri.foundry.main.dataset.3d2a3b65-ab92-488d-b44d-ce90b702be96"),
    RePORTER_PUBLNK_C_2010=Input(rid="ri.foundry.main.dataset.ed25aef8-825f-49d1-816d-07519d56c7b6"),
    RePORTER_PUBLNK_C_2011=Input(rid="ri.foundry.main.dataset.c3414c0a-6a92-43a4-90fc-b54194b526e7"),
    RePORTER_PUBLNK_C_2012=Input(rid="ri.foundry.main.dataset.d645ad7c-c385-4b39-9003-7a7bb021019b"),
    RePORTER_PUBLNK_C_2013=Input(rid="ri.foundry.main.dataset.bf9ec9cf-7a63-448a-8f88-b2ca8e008baf"),
    RePORTER_PUBLNK_C_2014=Input(rid="ri.foundry.main.dataset.425c34ce-e79b-4825-baaa-1a2e8289ec66"),
    RePORTER_PUBLNK_C_2015=Input(rid="ri.foundry.main.dataset.6c97e132-265e-4b99-b389-f9c0f7f48904"),
    RePORTER_PUBLNK_C_2016=Input(rid="ri.foundry.main.dataset.299ee1a9-59f3-4793-9310-1710d715ee19"),
    RePORTER_PUBLNK_C_2017=Input(rid="ri.foundry.main.dataset.ab6e7973-aa41-446a-88b6-cb0ea4e350af"),
    RePORTER_PUBLNK_C_2018=Input(rid="ri.foundry.main.dataset.545dbf02-f946-41b5-9daf-b51eb16ce856"),
    RePORTER_PUBLNK_C_2019=Input(rid="ri.foundry.main.dataset.dbdcae72-e2ed-48f1-91aa-24aecdd957c4")
)
from pyspark.sql import functions as F
def RJD4(RePORTER_PUBLNK_C_2009, RePORTER_PUBLNK_C_2010, RePORTER_PUBLNK_C_2011, RePORTER_PUBLNK_C_2012, RePORTER_PUBLNK_C_2013, RePORTER_PUBLNK_C_2014, RePORTER_PUBLNK_C_2015, RePORTER_PUBLNK_C_2016, RePORTER_PUBLNK_C_2017, RePORTER_PUBLNK_C_2018, RePORTER_PUBLNK_C_2019, RJD1):
    df=RePORTER_PUBLNK_C_2009
    df=df.union(RePORTER_PUBLNK_C_2010)
    df=df.union(RePORTER_PUBLNK_C_2011)
    df=df.union(RePORTER_PUBLNK_C_2012)
    df=df.union(RePORTER_PUBLNK_C_2013)
    df=df.union(RePORTER_PUBLNK_C_2014)
    df=df.union(RePORTER_PUBLNK_C_2015)
    df=df.union(RePORTER_PUBLNK_C_2016)
    df=df.union(RePORTER_PUBLNK_C_2017)
    df=df.union(RePORTER_PUBLNK_C_2018)
    df=df.union(RePORTER_PUBLNK_C_2019)
    df=df.withColumn("PROJECT_NUMBER",F.substring(df["PROJECT_NUMBER"],-8,8))
    df=df.distinct()
    df=df.withColumnRenamed("PMID","PMID1")
    df=df.join(RJD1,(df["PMID1"]==RJD1["PMID"]),'inner')
    df=df.select("PROJECT_NUMBER","PMID","PubYr")
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.271816e3-02c8-4e60-9680-fb775ce164a9"),
    Pubs2010=Input(rid="ri.foundry.main.dataset.ebe331e1-b289-4cde-9ab7-2821b84690cc"),
    Pubs2011=Input(rid="ri.foundry.main.dataset.e95110bb-9c0f-4533-9d32-59dd177e2e53"),
    Pubs2012=Input(rid="ri.foundry.main.dataset.ae5124fc-3ed0-49cb-87f0-4f184100ec60"),
    Pubs2013=Input(rid="ri.foundry.main.dataset.ac082b85-ede6-4592-9f23-5629831efeb6"),
    Pubs2014=Input(rid="ri.foundry.main.dataset.c4c98967-b82b-4a16-a2de-d0bceed29b86"),
    Pubs2015=Input(rid="ri.foundry.main.dataset.50bae6da-79b6-4f22-8741-4d921c8182a8"),
    Pubs2016=Input(rid="ri.foundry.main.dataset.1dd1ada2-fe0a-4cda-97be-c68366a93d55"),
    Pubs2017=Input(rid="ri.foundry.main.dataset.930ca23e-ad0d-4d4b-bc53-4048ad5b07d1"),
    Pubs2018=Input(rid="ri.foundry.main.dataset.bb185be2-c457-4c2d-bdea-b9256480010f"),
    Pubs2019=Input(rid="ri.foundry.main.dataset.0cb75481-037c-4eca-be7a-205a254979f7")
)
from pyspark.sql import functions as F
def RJD6(Pubs2010, Pubs2011, Pubs2012, Pubs2013, Pubs2014, Pubs2015, Pubs2016, Pubs2017, Pubs2018, Pubs2019):
    df=Pubs2010
    df=df.union(Pubs2011)
    df=df.union(Pubs2012)
    df=df.union(Pubs2013)
    df=df.union(Pubs2014)
    df=df.union(Pubs2015)
    df=df.union(Pubs2016)
    df=df.union(Pubs2017)
    df=df.union(Pubs2018)
    df=df.union(Pubs2019)
    df=df.withColumn("Grant_Number",F.split(df["Grant_Number"],";"))
    df=df.select("PMID","Pub_Year","Author_Last_Name","First_Author","Last_Author","Author_Count","RCR",F.explode("Grant_Number").alias("Gr_Num_Explode"))
    df=df.withColumn("Gr_Num_Explode",F.substring(df["Gr_Num_Explode"],-8,8))
    df=df.withColumn("Author_Last_Name",F.split(df["Author_Last_Name"],";"))
    df=df.select("PMID","Pub_Year","First_Author","Last_Author","Author_Count","RCR","Gr_Num_Explode",F.explode("Author_Last_Name").alias("AuLastName_Explode2"))
    df=df.withColumn("AuLastName_Explode2",F.upper(F.col("AuLastName_Explode2")))
    df=df.withColumn('AuLastName_Explode2',F.regexp_replace('AuLastName_Explode2',r'[^a-zA-Z]',''))
    df=df.withColumnRenamed("PMID","PMID_Inv")
    df=df.filter(df["PMID_Inv"].isNotNull())
    df=df.select("PMID_Inv","Pub_Year","Author_Count","Gr_Num_Explode","AuLastName_Explode2")
    return df

@transform_pandas(
    Output(rid="ri.foundry.main.dataset.f7de7c8a-fffa-479c-92fd-7accfe2e9113"),
    BIBL2010=Input(rid="ri.foundry.main.dataset.d31ebfe4-5053-477c-ad1f-b7395586c87c"),
    BIBL2011=Input(rid="ri.foundry.main.dataset.d5771003-d4e3-432b-b1a5-574b6a6931bc"),
    BIBL2012=Input(rid="ri.foundry.main.dataset.157010d6-27b1-4060-9c73-f3dfe49c2416"),
    BIBL2013=Input(rid="ri.foundry.main.dataset.12ca48b7-4e2e-44b8-a0bc-59d1da371d56"),
    BIBL2014=Input(rid="ri.foundry.main.dataset.1e7c58ca-310d-4568-b38a-cb267338a1f3"),
    BIBL2015=Input(rid="ri.foundry.main.dataset.31062c32-2b40-49a8-bb5a-87ca8429dbb4"),
    BIBL2016=Input(rid="ri.foundry.main.dataset.54d568f3-b868-46a4-8fb7-da7e39c77d54"),
    BIBL2017=Input(rid="ri.foundry.main.dataset.f45d05f3-6708-4d4c-986a-fd0e345f3aa2"),
    BIBL2018=Input(rid="ri.foundry.main.dataset.8b1b8336-c828-4b55-8bd2-2b921e030c68"),
    BIBL2019=Input(rid="ri.foundry.main.dataset.81f76a63-1e75-4b89-a5fe-8246a4a3f264")
)
def iCite_WOS(BIBL2010, BIBL2011, BIBL2012, BIBL2013, BIBL2014, BIBL2015, BIBL2016, BIBL2017, BIBL2018, BIBL2019):
    df=BIBL2010
    df=df.union(BIBL2011)
    df=df.union(BIBL2012)
    df=df.union(BIBL2013)
    df=df.union(BIBL2014)
    df=df.union(BIBL2015)
    df=df.union(BIBL2016)
    df=df.union(BIBL2017)
    df=df.union(BIBL2018)
    df=df.union(BIBL2019)
    return df

